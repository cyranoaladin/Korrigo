version: "1.0"
project: "Korrigo PMF"
mission: "Audit complet + correctifs + preuves (tests) + verdict prod"
criticality: "EXAM-GRADE-CRITICAL"
rules:
  - "Fail-fast: tout item Gate=STOP bloque le verdict DEPLOYABLE"
  - "Toute conclusion doit être prouvée par: test + log + référence de fichier"
  - "Interdiction des zones grises: si non prouvé => KO"
artifacts_expected:
  - "REPORT.md (audit structuré + preuves)"
  - "GAP_ANALYSIS.md (SPEC->Code->Tests->Statut)"
  - "TEST_PLAN.md (plan et couverture)"
  - "PATCHES/ (diffs ou commits détaillés)"
  - "RUNBOOK_PROD.md (déploiement + backup/restore)"
inputs_docs:
  - path: "/mnt/data/README.md"
    purpose: "quickstart + workflow de base"
  - path: "/mnt/data/SPEC.md"
    purpose: "exigences fonctionnelles"
  - path: "/mnt/data/ARCHITECTURE.md"
    purpose: "architecture + flux + docker"
  - path: "/mnt/data/BUSINESS_WORKFLOWS.md"
    purpose: "workflows métier + rôles"
  - path: "/mnt/data/TECHNICAL_MANUAL.md"
    purpose: "algos critiques + coordonnées annotations + config"
  - path: "/mnt/data/PDF_VALIDATORS_IMPLEMENTATION.md"
    purpose: "P1 validators + tests"
  - path: "/mnt/data/ADVANCED_PDF_VALIDATORS.md"
    purpose: "P2/P3 validators + tests + sécurité"
execution_order:
  - phase: "P0_READ_AND_MAP"
    tasks:
      - id: "P0.1"
        name: "Lire toute la doc et construire la matrice de conformité"
        gate: "STOP"
        actions:
          - "Construire GAP_ANALYSIS.md: chaque exigence SPEC + workflows -> (fichier code, endpoint UI, tests) -> OK/KO"
          - "Identifier explicitement les exigences manquantes ou ambiguës"
        evidence:
          - "GAP_ANALYSIS.md rempli à 100%"
          - "Liste des exigences sans preuve => KO"
  - phase: "P1_ENV_AND_REPRO"
    tasks:
      - id: "P1.1"
        name: "Reproductibilité locale via docker compose"
        gate: "STOP"
        actions:
          - "Lancer l'app en dev (make up / docker-compose up)"
          - "Vérifier: backend, frontend, celery, redis, postgres"
          - "Exécuter la suite de tests existante (make test si présent) et consigner résultats"
        evidence:
          - "Logs de démarrage services"
          - "Rapport d'exécution des tests (pass/fail + stacktraces)"
      - id: "P1.2"
        name: "Configuration env: secrets, hosts, URLs, CORS"
        gate: "STOP"
        actions:
          - "Auditer variables .env et settings Django / Vite"
          - "Identifier risques prod: DEBUG, ALLOWED_HOSTS, session cookies, CSRF, CORS"
        evidence:
          - "Checklist config (dev/prod) + recommandations"
  - phase: "P2_FUNCTIONAL_SPEC_COVERAGE"
    tasks:
      - id: "P2.1"
        name: "Portails séparés Admin / Prof / Élève (auth + RBAC)"
        gate: "STOP"
        actions:
          - "Lister routes UI et endpoints API pour chaque rôle"
          - "Tester accès non autorisé: doit être refusé"
          - "Vérifier séparation stricte demandée par SPEC"
        evidence:
          - "Table RBAC: endpoint -> permission -> test associé"
      - id: "P2.2"
        name: "Workflow E2E 'Bac Blanc' (de PDF vrac à portail élève)"
        gate: "STOP"
        actions:
          - "Créer un jeu de données minimal: PDF test + élèves + examen"
          - "Rejouer workflow complet: upload->split->booklets->identification->anonymisation->lock->annot->score->finalize->export->portail élève"
          - "Automatiser en tests E2E (Playwright si présent) ou API-level tests"
        evidence:
          - "Test E2E qui passe en CI locale"
          - "Capture des états Copy et fichiers générés"
  - phase: "P3_STATE_MACHINE_AND_CONCURRENCY"
    tasks:
      - id: "P3.1"
        name: "Machine à états Copy (transitions strictes)"
        gate: "STOP"
        actions:
          - "Vérifier états attendus: INGESTED/IDENTIFIED/READY/LOCKED/GRADED"
          - "Tester transitions interdites (ex: finalize sans lock)"
          - "Vérifier atomicité (transaction.atomic) dans services"
        evidence:
          - "Unit/service tests sur transitions"
      - id: "P3.2"
        name: "Concurrence: lock, autosave, reprise"
        gate: "STOP"
        actions:
          - "Simuler 2 sessions prof sur la même copie: un seul lock"
          - "Simuler refresh/crash pendant annotation: reprise via DraftState/localStorage si prévu"
          - "Tester absence de double finalisation"
        evidence:
          - "Tests + logs prouvant l'unicité du lock"
  - phase: "P4_GRADING_CORRECTNESS"
    tasks:
      - id: "P4.1"
        name: "Exactitude des annotations (coordonnées relatives -> PDF)"
        gate: "STOP"
        actions:
          - "Tester export PDF: alignement exact (pas de décalage)"
          - "Tester différents zoom/tailles écran"
          - "Vérifier projection x_rel/y_rel -> x_pdf/y_pdf"
        evidence:
          - "Test automatique comparant positions (si possible) ou validation par rendu contrôlé"
      - id: "P4.2"
        name: "Calcul des scores (déterministe, recalculable, explicable)"
        gate: "STOP"
        actions:
          - "Recalculer le score à partir de DB seule"
          - "Tester arrondis, bonus/malus, bornes min/max"
          - "Vérifier cohérence barème hiérarchique"
        evidence:
          - "Tests sur scénarios de barème (arbre)"
          - "Exemples de calculs justifiés"
  - phase: "P5_PDF_SECURITY_AND_VALIDATION"
    tasks:
      - id: "P5.1"
        name: "Validators PDF P1/P2/P3 appliqués partout"
        gate: "STOP"
        actions:
          - "Vérifier FileField validators sur Exam et Copy"
          - "Tester: extension, taille, vide, MIME, intégrité, pages max"
          - "Tester graceful degradation MIME/AV si optionnels"
        evidence:
          - "Tests existants passent + tests manquants ajoutés"
      - id: "P5.2"
        name: "Résistance aux PDFs malveillants"
        gate: "STOP"
        actions:
          - "Faux PDF renommé, PDF corrompu, PDF 600 pages, PDF lourd"
          - "Vérifier erreurs claires (pas de 500 ni d'exception non gérée)"
        evidence:
          - "Rapport d'attaque (résultats attendus/obtenus)"
  - phase: "P6_AUDIT_TRAIL_AND_ACCOUNTABILITY"
    tasks:
      - id: "P6.1"
        name: "Audit trail complet (qui a fait quoi, quand)"
        gate: "STOP"
        actions:
          - "Vérifier création d'événements: import, identify, lock, annotate, score change, finalize, export"
          - "Vérifier horodatage, user, copy_id, payload minimal"
        evidence:
          - "Logs/DB query prouvant la présence des événements"
  - phase: "P7_PROD_READINESS"
    tasks:
      - id: "P7.1"
        name: "Docker prod/prodlike, nginx, gunicorn, static/media"
        gate: "STOP"
        actions:
          - "Vérifier compose prod: DEBUG=false, ports, TLS si prévu"
          - "Tester génération fichiers finaux en volume persistant"
        evidence:
          - "Démarrage prodlike OK + smoke tests"
      - id: "P7.2"
        name: "Backup/Restore (DB + media)"
        gate: "STOP"
        actions:
          - "Définir procédure backup (pg_dump + archive media)"
          - "Tester restauration complète sur environnement vierge"
        evidence:
          - "RUNBOOK_PROD.md + preuve restore réussi"
exit_criteria:
  deployable_requires:
    - "Toutes tâches gate=STOP => OK"
    - "Tests: unit + service + e2e => verts"
    - "Aucun bug 'silent failure' connu"
    - "Runbook prod + backup/restore validés"
  verdict_values: ["DEPLOYABLE", "NON_DEPLOYABLE"]
report_template:
  sections:
    - "Résumé exécutif + verdict"
    - "Matrice SPEC->Code->Tests"
    - "Risques critiques (P0/P1/P2) + correctifs"
    - "Couverture tests (table)"
    - "Runbook prod"

