# 06.4 - Configuration Nginx

**Projet** : Korrigo - Syst√®me de Correction d'Examens
**Version** : 2.0 (PRD-19)
**Date** : 3 F√©vrier 2026
**Auteur** : **Alaeddine BEN RHOUMA**

---

## üéØ Objectif

Ce document d√©crit la **configuration compl√®te de Nginx** pour le syst√®me Korrigo, incluant reverse proxy, SSL, caching, rate limiting, et optimisations performance.

---

## üìã R√¥le de Nginx

Nginx sert de **reverse proxy** entre clients et backend Django :

1. **Reverse Proxy** : Redirection requ√™tes ‚Üí Gunicorn (Django)
2. **SSL Termination** : Gestion HTTPS (Let's Encrypt)
3. **Fichiers Statiques** : Serving direct (CSS, JS, images)
4. **Fichiers Media** : Serving PDF, uploads
5. **Caching** : Cache HTTP r√©ponses API
6. **Rate Limiting** : Protection anti-DDoS
7. **Compression** : Gzip compression
8. **Security Headers** : HSTS, CSP, X-Frame-Options

---

## üìÇ Structure Configuration

### Fichiers

```
infra/nginx/
‚îú‚îÄ‚îÄ nginx.conf              # Configuration principale
‚îú‚îÄ‚îÄ ssl/                    # Certificats SSL
‚îÇ   ‚îú‚îÄ‚îÄ dhparam.pem        # Diffie-Hellman parameters
‚îÇ   ‚îî‚îÄ‚îÄ options-ssl-nginx.conf  # Options SSL
‚îú‚îÄ‚îÄ conf.d/                 # Configurations suppl√©mentaires
‚îÇ   ‚îú‚îÄ‚îÄ gzip.conf
‚îÇ   ‚îú‚îÄ‚îÄ security.conf
‚îÇ   ‚îî‚îÄ‚îÄ cache.conf
‚îî‚îÄ‚îÄ sites-available/
    ‚îî‚îÄ‚îÄ korrigo.conf        # Configuration site
```

---

## üîß Configuration Principale

### Fichier : `infra/nginx/nginx.conf`

```nginx
user nginx;
worker_processes auto;  # Auto-detect CPU cores
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# Load dynamic modules
include /usr/share/nginx/modules/*.conf;

events {
    worker_connections 1024;
    use epoll;  # Optimal pour Linux
    multi_accept on;
}

http {
    # Basic Settings
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;  # Cacher version Nginx

    # Buffer Sizes
    client_body_buffer_size 128k;
    client_max_body_size 100M;  # Max upload size
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    # Timeouts
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;

    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # Rate Limiting Zones
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/m;
    limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/m;

    # Connection Limiting
    limit_conn_zone $binary_remote_addr zone=addr:10m;

    # Cache Zones
    proxy_cache_path /var/cache/nginx/static
                     levels=1:2
                     keys_zone=static_cache:10m
                     max_size=500m
                     inactive=60m
                     use_temp_path=off;

    proxy_cache_path /var/cache/nginx/api
                     levels=1:2
                     keys_zone=api_cache:10m
                     max_size=100m
                     inactive=10m
                     use_temp_path=off;

    # Upstream Backend
    upstream django_backend {
        server backend:8000 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # Include site configs
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
```

---

## üåê Configuration Site

### Fichier : `infra/nginx/sites-available/korrigo.conf`

```nginx
# ============================================
# HTTP ‚Üí HTTPS Redirect
# ============================================
server {
    listen 80;
    listen [::]:80;
    server_name korrigo.yourdomain.com www.korrigo.yourdomain.com;

    # Certbot ACME Challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ============================================
# HTTPS Main Server
# ============================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name korrigo.yourdomain.com www.korrigo.yourdomain.com;

    # Root directory (pour fichiers statiques)
    root /app;

    # =====================================
    # SSL Configuration
    # =====================================
    ssl_certificate /etc/letsencrypt/live/korrigo.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/korrigo.yourdomain.com/privkey.pem;

    # SSL Protocols
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL Session Cache
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/letsencrypt/live/korrigo.yourdomain.com/chain.pem;

    # Diffie-Hellman parameter
    ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    # =====================================
    # Security Headers
    # =====================================
    # HSTS (HTTP Strict Transport Security)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # XSS Protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer Policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy (ajuster selon besoins)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss:; frame-ancestors 'self';" always;

    # Permissions Policy
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # =====================================
    # Rate Limiting
    # =====================================
    # General rate limit
    limit_req zone=general burst=20 nodelay;
    limit_conn addr 10;

    # =====================================
    # Logging
    # =====================================
    access_log /var/log/nginx/korrigo_access.log main;
    error_log /var/log/nginx/korrigo_error.log warn;

    # =====================================
    # Static Files (CSS, JS, Images)
    # =====================================
    location /static/ {
        alias /app/staticfiles/;

        # Cache control
        expires 30d;
        add_header Cache-Control "public, immutable";

        # Compression
        gzip_static on;

        # Security (disable script execution)
        location ~* \.(html|htm|php)$ {
            deny all;
        }
    }

    # =====================================
    # Media Files (Uploads, PDFs)
    # =====================================
    location /media/ {
        alias /app/media/;

        # Cache control (shorter que static)
        expires 7d;
        add_header Cache-Control "public";

        # Security headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header Content-Security-Policy "default-src 'none'; style-src 'unsafe-inline'; sandbox" always;

        # Prevent script execution
        location ~* \.(html|htm|php|js)$ {
            deny all;
        }

        # PDF download avec nom fichier
        location ~* \.pdf$ {
            add_header Content-Disposition "attachment";
        }
    }

    # =====================================
    # API Endpoints
    # =====================================
    location /api/ {
        # Rate limiting API
        limit_req zone=api burst=50 nodelay;

        # Proxy to Django backend
        proxy_pass http://django_backend;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Cache GET requests (uniquement endpoints sp√©cifiques)
        proxy_cache api_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        proxy_cache_lock on;

        # Cache bypass pour requ√™tes authentifi√©es
        proxy_cache_bypass $http_authorization $cookie_sessionid;
        proxy_no_cache $http_authorization $cookie_sessionid;

        # Add cache status header (debug)
        add_header X-Cache-Status $upstream_cache_status;
    }

    # =====================================
    # Authentication Endpoints (stricter rate limit)
    # =====================================
    location ~ ^/api/(auth/|students/login/) {
        limit_req zone=auth burst=5 nodelay;

        proxy_pass http://django_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Pas de cache
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    # =====================================
    # Upload Endpoints (stricter rate limit + large body)
    # =====================================
    location ~ ^/api/exams/upload/ {
        limit_req zone=upload burst=2 nodelay;

        # Large uploads
        client_max_body_size 100M;
        client_body_timeout 300s;

        proxy_pass http://django_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long timeout pour uploads
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # Disable buffering (streaming upload)
        proxy_request_buffering off;
    }

    # =====================================
    # WebSocket (Django Channels)
    # =====================================
    location /ws/ {
        proxy_pass http://django_backend;

        # WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts (long-lived connections)
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }

    # =====================================
    # Django Admin
    # =====================================
    location /admin/ {
        # Rate limit (mod√©r√©)
        limit_req zone=general burst=10 nodelay;

        proxy_pass http://django_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Pas de cache
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    # =====================================
    # Health Check (no rate limit)
    # =====================================
    location /api/health/ {
        proxy_pass http://django_backend;
        proxy_set_header Host $host;

        # Pas de rate limiting pour health checks
        limit_req off;
        limit_conn off;

        access_log off;  # Ne pas logger les health checks
    }

    # =====================================
    # Frontend SPA (Vue.js)
    # =====================================
    location / {
        root /app/frontend/dist;
        try_files $uri $uri/ /index.html;

        # Cache HTML court, assets long
        location ~* \.(html)$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
        }

        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # =====================================
    # Security: Deny access to hidden files
    # =====================================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to backup files
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}
```

---

## üîê Configuration SSL

### G√©n√©ration Diffie-Hellman Parameters

```bash
# G√©n√©rer dhparam (peut prendre plusieurs minutes)
openssl dhparam -out infra/nginx/ssl/dhparam.pem 4096
```

### Options SSL (fichier s√©par√©)

**Fichier** : `infra/nginx/ssl/options-ssl-nginx.conf`

```nginx
# SSL Protocols
ssl_protocols TLSv1.2 TLSv1.3;

# SSL Ciphers (Modern)
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';

ssl_prefer_server_ciphers off;

# SSL Session
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;
```

---

## üöÄ Optimisation Performance

### 1. Gzip Compression

**Fichier** : `infra/nginx/conf.d/gzip.conf`

```nginx
# Enable Gzip
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 256;

# Gzip Types
gzip_types
    application/atom+xml
    application/geo+json
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rdf+xml
    application/rss+xml
    application/vnd.ms-fontobject
    application/wasm
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/eot
    font/otf
    font/ttf
    image/bmp
    image/svg+xml
    text/cache-manifest
    text/calendar
    text/css
    text/javascript
    text/markdown
    text/plain
    text/xml
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy;

gzip_disable "msie6";
```

### 2. Caching Statique

**Fichier** : `infra/nginx/conf.d/cache.conf`

```nginx
# Cache pour fichiers statiques
location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
    expires 365d;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# Cache court HTML
location ~* \.(html|htm)$ {
    expires 1h;
    add_header Cache-Control "public, must-revalidate";
}

# Pas de cache pour API
location ~* ^/api/ {
    expires off;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
```

### 3. HTTP/2 Push (optionnel)

```nginx
location = /index.html {
    http2_push /static/css/main.css;
    http2_push /static/js/main.js;
}
```

---

## üõ°Ô∏è S√©curit√©

### 1. Rate Limiting D√©taill√©

**Zones d√©finies** :

| Zone | Rate | Burst | Usage |
|------|------|-------|-------|
| `general` | 10 req/s | 20 | Requ√™tes g√©n√©rales |
| `api` | 30 req/s | 50 | Endpoints API |
| `auth` | 5 req/m | 5 | Login/authentification |
| `upload` | 2 req/m | 2 | Upload PDF |

**Tester rate limiting** :

```bash
# Tester limite auth (5 req/min)
for i in {1..10}; do
  curl -X POST https://korrigo.yourdomain.com/api/students/login/ \
    -d '{"email":"test@test.com","date_of_birth":"01/01/2000"}'
  echo ""
done

# R√©ponse attendue apr√®s 5 requ√™tes:
# 429 Too Many Requests
```

### 2. Blacklist IPs

**Bloquer IPs malveillantes** :

```nginx
# Dans http block
geo $blocked_ip {
    default 0;
    192.168.1.100 1;  # IP √† bloquer
    203.0.113.0/24 1;  # Subnet √† bloquer
}

# Dans server block
if ($blocked_ip) {
    return 403;
}
```

### 3. Bloquer User-Agents

```nginx
# Bloquer bots malveillants
map $http_user_agent $bad_bot {
    default 0;
    ~*bot 0;  # Autoriser bots l√©gitimes
    ~*BadBot 1;
    ~*SemrushBot 1;
    ~*AhrefsBot 1;
}

server {
    if ($bad_bot) {
        return 403;
    }
}
```

---

## üìä Monitoring

### Logs Nginx

**Consulter logs temps r√©el** :

```bash
# Access logs
docker compose -f docker-compose.prod.yml exec nginx tail -f /var/log/nginx/korrigo_access.log

# Error logs
docker compose -f docker-compose.prod.yml exec nginx tail -f /var/log/nginx/korrigo_error.log

# Filtrer erreurs 5xx
docker compose -f docker-compose.prod.yml exec nginx grep " 5[0-9][0-9] " /var/log/nginx/korrigo_access.log
```

### Analyse Logs

**GoAccess (analyse temps r√©el)** :

```bash
# Installer GoAccess
apt install -y goaccess

# Analyse logs
goaccess /var/log/nginx/korrigo_access.log -o report.html --log-format=COMBINED

# Servir rapport
python3 -m http.server 8080
# Ouvrir http://localhost:8080/report.html
```

### Nginx Status Page

**Activer stub_status** :

```nginx
# Ajouter dans server block
location /nginx_status {
    stub_status;
    access_log off;
    allow 127.0.0.1;  # Uniquement localhost
    deny all;
}
```

**Consulter** :

```bash
curl http://localhost/nginx_status
```

**Output** :
```
Active connections: 42
server accepts handled requests
 1024 1024 2048
Reading: 0 Writing: 2 Waiting: 40
```

---

## üß™ Tests Configuration

### Validation Syntaxe

```bash
# Tester configuration
docker compose -f docker-compose.prod.yml exec nginx nginx -t

# Output attendu:
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### Reload Sans Downtime

```bash
# Reload graceful
docker compose -f docker-compose.prod.yml exec nginx nginx -s reload

# OU
docker compose -f docker-compose.prod.yml exec nginx kill -HUP 1
```

### Tests Performance

**Apache Bench** :

```bash
# Test 1000 requ√™tes, 10 concurrent
ab -n 1000 -c 10 https://korrigo.yourdomain.com/api/health/
```

**Siege** :

```bash
# Test charge pendant 30s
siege -c 50 -t 30s https://korrigo.yourdomain.com/
```

---

## üìù Conclusion

La configuration Nginx optimise les performances, la s√©curit√© et la fiabilit√© du syst√®me Korrigo. Le reverse proxy g√®re SSL, rate limiting, caching, et compression pour offrir une exp√©rience utilisateur optimale.

**Points cl√©s** :
- HTTP/2 + SSL/TLS 1.3
- Rate limiting multi-zones
- Caching strat√©gique (static, API)
- Security headers complets
- Compression Gzip
- Monitoring int√©gr√©
- Configuration modulaire

---

**Document r√©dig√© par :**
**Alaeddine BEN RHOUMA**
*Lead Senior Documentation & Architecture*
Date : 3 F√©vrier 2026
