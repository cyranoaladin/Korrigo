# 06.2 - Installation et D√©ploiement Local

**Projet** : Korrigo - Syst√®me de Correction d'Examens
**Version** : 2.0 (PRD-19)
**Date** : 3 F√©vrier 2026
**Auteur** : **Alaeddine BEN RHOUMA**

---

## üéØ Objectif

Ce guide permet de **d√©ployer Korrigo en local** dans des conditions identiques √† la production, pour tests, d√©monstrations ou d√©veloppement.

### Pr√©requis

- **OS** : Linux (Ubuntu 22.04+), macOS, Windows (WSL2)
- **Docker** : 24.x ou sup√©rieur
- **Docker Compose** : 2.x ou sup√©rieur
- **Git** : Pour cloner le repository
- **M√©moire RAM** : Minimum 8 GB (recommand√© 16 GB pour OCR)
- **Espace disque** : 20 GB minimum

---

## üìã √âtape 1 : Installation des Pr√©requis

### 1.1 Installation Docker (Ubuntu/Debian)

```bash
# 1. Mettre √† jour les paquets
sudo apt-get update
sudo apt-get install -y ca-certificates curl gnupg

# 2. Ajouter la cl√© GPG officielle de Docker
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# 3. Ajouter le repository Docker
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 4. Installer Docker
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 5. V√©rifier l'installation
docker --version
docker compose version

# 6. Ajouter utilisateur au groupe docker (√©viter sudo)
sudo usermod -aG docker $USER
newgrp docker

# 7. Tester Docker
docker run hello-world
```

### 1.2 Installation Docker (macOS)

```bash
# T√©l√©charger Docker Desktop for Mac
# https://www.docker.com/products/docker-desktop/

# Installer via DMG
# V√©rifier
docker --version
docker compose version
```

### 1.3 Installation Docker (Windows WSL2)

```powershell
# 1. Activer WSL2
wsl --install

# 2. T√©l√©charger Docker Desktop for Windows
# https://www.docker.com/products/docker-desktop/

# 3. Installer et activer int√©gration WSL2
# Settings ‚Üí Resources ‚Üí WSL Integration ‚Üí Enable Ubuntu

# 4. V√©rifier (dans Ubuntu WSL)
docker --version
docker compose version
```

---

## üì• √âtape 2 : Cloner le Repository

```bash
# 1. Cr√©er r√©pertoire de travail
mkdir -p ~/projects
cd ~/projects

# 2. Cloner le repository
git clone https://github.com/your-org/korrigo.git
cd korrigo

# 3. V√©rifier structure
ls -la

# Structure attendue:
# backend/
# frontend/
# infra/
#   ‚îú‚îÄ‚îÄ docker/
#   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.local-prod.yml
#   ‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.dev.yml
#   ‚îî‚îÄ‚îÄ nginx/
#       ‚îî‚îÄ‚îÄ nginx.conf
# documentation/
# CSV/
# README.md
```

---

## ‚öôÔ∏è √âtape 3 : Configuration Environnement

### 3.1 Cr√©er Fichier .env (Backend)

```bash
# Cr√©er fichier .env.prod dans backend/
cd backend
touch .env.prod
```

**Contenu** (`backend/.env.prod`) :

```bash
# Django
DJANGO_SETTINGS_MODULE=config.settings
SECRET_KEY=your-very-secret-key-change-in-production-1234567890
DEBUG=False
ALLOWED_HOSTS=localhost,127.0.0.1,korrigo.labomths.tn

# Database
DB_ENGINE=django.db.backends.postgresql
DB_NAME=korrigo_db
DB_USER=korrigo_user
DB_PASSWORD=secure_db_password_change_me
DB_HOST=db
DB_PORT=5432

# Redis
REDIS_URL=redis://redis:6379/0

# Celery
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/0

# OCR
TESSERACT_PATH=/usr/bin/tesseract
OCR_CACHE_DIR=/app/.cache/

# Media
MEDIA_ROOT=/app/media/
MEDIA_URL=/media/
STATIC_ROOT=/app/static/
STATIC_URL=/static/

# Security (Production)
SECURE_SSL_REDIRECT=False
SESSION_COOKIE_SECURE=False
CSRF_COOKIE_SECURE=False
```

### 3.2 Cr√©er Fichier .env (Frontend)

```bash
cd ../frontend
touch .env.production
```

**Contenu** (`frontend/.env.production`) :

```bash
VITE_API_URL=http://localhost:8088
NODE_ENV=production
```

---

## üèóÔ∏è √âtape 4 : Build des Images Docker

### 4.1 Build Backend

```bash
cd ~/projects/korrigo

# Build image backend (peut prendre 15-20 minutes la premi√®re fois)
docker compose -f infra/docker/docker-compose.local-prod.yml build backend

# V√©rifier taille image (~9.94 GB avec OCR)
docker images | grep korrigo
```

**Contenu Dockerfile** (`backend/Dockerfile`) :

```dockerfile
FROM python:3.9-slim

# System dependencies
RUN apt-get update && apt-get install -y \
    postgresql-client \
    libpq-dev \
    gcc \
    g++ \
    tesseract-ocr \
    tesseract-ocr-fra \
    libtesseract-dev \
    libgl1-mesa-glibg \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Working directory
WORKDIR /app

# Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Application code
COPY . .

# Collect static files
RUN python manage.py collectstatic --noinput

# Expose port
EXPOSE 8000

# Gunicorn command
CMD ["gunicorn", "config.wsgi:application", \
     "--bind", "0.0.0.0:8000", \
     "--workers", "3", \
     "--timeout", "300", \
     "--access-logfile", "-", \
     "--error-logfile", "-"]
```

### 4.2 Build Frontend

```bash
cd frontend

# Installer d√©pendances
npm install

# Build production
npm run build

# V√©rifier dist/
ls -la dist/
```

---

## üöÄ √âtape 5 : Lancement des Services

### 5.1 D√©marrer Docker Compose

```bash
cd ~/projects/korrigo

# D√©marrer tous les services
docker compose -f infra/docker/docker-compose.local-prod.yml up -d

# V√©rifier que tous les services sont UP
docker compose -f infra/docker/docker-compose.local-prod.yml ps

# Output attendu:
# NAME                STATUS              PORTS
# korrigo-backend     Up (healthy)
# korrigo-celery      Up
# korrigo-db          Up (healthy)        5432/tcp
# korrigo-redis       Up (healthy)        6379/tcp
# korrigo-nginx       Up (healthy)        0.0.0.0:8088->80/tcp
```

### 5.2 V√©rifier les Logs

```bash
# Voir tous les logs
docker compose -f infra/docker/docker-compose.local-prod.yml logs -f

# Logs backend uniquement
docker compose -f infra/docker/docker-compose.local-prod.yml logs -f backend

# Logs avec grep
docker compose -f infra/docker/docker-compose.local-prod.yml logs backend | grep ERROR
```

---

## üóÑÔ∏è √âtape 6 : Initialisation Base de Donn√©es

### 6.1 Ex√©cuter Migrations

```bash
# Appliquer migrations Django
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py migrate

# Output attendu:
# Operations to perform:
#   Apply all migrations: admin, auth, contenttypes, core, exams, grading, identification, processing, sessions, students
# Running migrations:
#   Applying contenttypes.0001_initial... OK
#   Applying auth.0001_initial... OK
#   ...
#   Applying students.0002_add_user_link... OK
```

### 6.2 Cr√©er Superuser

```bash
# M√©thode 1: Interactive
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py createsuperuser

# Prompts:
# Username: admin
# Email: admin@korrigo.tn
# Password: [saisir mot de passe s√©curis√©]
# Password (again): [confirmer]
```

### 6.3 Seed Donn√©es de Test

```bash
# Ex√©cuter script seed
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py shell < seed_prod.py

# OU cr√©er donn√©es de test manuellement
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py shell
```

**Contenu** (`backend/seed_prod.py`) :

```python
from django.contrib.auth import get_user_model
from django.contrib.auth.models import Group
from students.models import Student
from exams.models import Exam, Copy
from datetime import date, datetime
import uuid

User = get_user_model()

# 1. Cr√©er groupes
teacher_group, _ = Group.objects.get_or_create(name='teacher')
admin_group, _ = Group.objects.get_or_create(name='admin')

# 2. Cr√©er admins
admin, _ = User.objects.get_or_create(
    username='test_admin',
    defaults={
        'email': 'admin@korrigo.tn',
        'is_staff': True,
        'is_superuser': True,
        'first_name': 'Admin',
        'last_name': 'Korrigo'
    }
)
admin.set_password('admin123')
admin.save()
admin.groups.add(teacher_group, admin_group)

# 3. Cr√©er enseignants
prof, _ = User.objects.get_or_create(
    username='test_prof',
    defaults={
        'email': 'prof@korrigo.tn',
        'is_staff': True,
        'first_name': 'Professeur',
        'last_name': 'Test'
    }
)
prof.set_password('prof123')
prof.save()
prof.groups.add(teacher_group)

# 4. Cr√©er √©tudiants
for i in range(1, 11):
    student_user, created = User.objects.get_or_create(
        username=f'eleve{i}',
        defaults={
            'email': f'eleve{i}@viatique.local',
            'first_name': f'√âl√®ve{i}',
            'last_name': f'Test{i}',
            'is_staff': False
        }
    )
    if created:
        student_user.set_password('eleve2025')
        student_user.save()

    Student.objects.get_or_create(
        user=student_user,
        defaults={
            'first_name': f'√âl√®ve{i}',
            'last_name': f'Test{i}',
            'email': f'eleve{i}@viatique.local',
            'date_of_birth': date(2008, 1, i),
            'class_name': 'G3',
            'student_number': f'STU{i:03d}'
        }
    )

print("‚úÖ Seed completed:")
print(f"  - {User.objects.count()} users")
print(f"  - {Student.objects.count()} students")
```

---

## ‚úÖ √âtape 7 : V√©rification Installation

### 7.1 Health Checks

```bash
# Backend alive
curl http://localhost:8088/api/health/live/

# Backend ready (DB + Redis)
curl http://localhost:8088/api/health/ready/

# R√©ponse attendue:
# {
#   "status": "healthy",
#   "database": "connected",
#   "redis": "connected",
#   "timestamp": "2026-02-03T10:30:00Z"
# }
```

### 7.2 Acc√©der aux Interfaces

**Frontend** :
```
http://localhost:8088/
```

**Django Admin** :
```
http://localhost:8088/admin/
Login: test_admin / admin123
```

**API Docs** (si install√© drf-yasg) :
```
http://localhost:8088/api/docs/
```

### 7.3 Tester Login

```bash
# Login admin
curl -X POST http://localhost:8088/api/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"test_admin","password":"admin123"}' \
  -c cookies.txt

# V√©rifier session
curl -X GET http://localhost:8088/api/me/ \
  -b cookies.txt

# R√©ponse attendue:
# {
#   "id": 1,
#   "username": "test_admin",
#   "role": "Admin",
#   "is_staff": true,
#   "is_superuser": true
# }
```

---

## üß™ √âtape 8 : Tests Optionnels

### 8.1 Tests Backend (Pytest)

```bash
# Tous les tests
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend pytest

# Tests avec coverage
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend pytest --cov

# Tests sp√©cifiques
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend pytest processing/tests/test_batch_processor.py -v
```

### 8.2 Tests Frontend (Playwright)

```bash
cd frontend

# Installer Playwright
npx playwright install

# Run E2E tests
npx playwright test

# Run avec UI
npx playwright test --ui
```

---

## üõ†Ô∏è √âtape 9 : Commandes Utiles

### Gestion Services

```bash
# Arr√™ter services
docker compose -f infra/docker/docker-compose.local-prod.yml stop

# Red√©marrer service
docker compose -f infra/docker/docker-compose.local-prod.yml restart backend

# Reconstruire et red√©marrer
docker compose -f infra/docker/docker-compose.local-prod.yml up -d --build backend

# Supprimer conteneurs (garder volumes)
docker compose -f infra/docker/docker-compose.local-prod.yml down

# Supprimer TOUT (‚ö†Ô∏è perte donn√©es)
docker compose -f infra/docker/docker-compose.local-prod.yml down -v
```

### Exec dans Conteneur

```bash
# Shell backend
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend bash

# Django shell
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py shell

# PostgreSQL shell
docker compose -f infra/docker/docker-compose.local-prod.yml exec db psql -U korrigo_user -d korrigo_db
```

### Gestion Base de Donn√©es

```bash
# Backup DB
docker compose -f infra/docker/docker-compose.local-prod.yml exec db pg_dump -U korrigo_user korrigo_db > backup.sql

# Restore DB
cat backup.sql | docker compose -f infra/docker/docker-compose.local-prod.yml exec -T db psql -U korrigo_user -d korrigo_db

# Reset DB (‚ö†Ô∏è perte donn√©es)
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py flush --noinput
```

---

## üêõ D√©pannage

### Probl√®me 1 : Port 8088 d√©j√† utilis√©

**Sympt√¥me** :
```
Error starting userland proxy: listen tcp4 0.0.0.0:8088: bind: address already in use
```

**Solution** :
```bash
# Trouver processus utilisant port
sudo lsof -i :8088

# Tuer processus
sudo kill -9 <PID>

# OU changer port dans docker-compose.yml
# ports:
#   - "8089:80"  # Utiliser 8089 au lieu de 8088
```

### Probl√®me 2 : Backend unhealthy

**Sympt√¥me** :
```
korrigo-backend   Up (unhealthy)
```

**Solution** :
```bash
# V√©rifier logs
docker compose -f infra/docker/docker-compose.local-prod.yml logs backend

# V√©rifier DB connection
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py check --database default

# Red√©marrer backend
docker compose -f infra/docker/docker-compose.local-prod.yml restart backend
```

### Probl√®me 3 : Migrations √©chouent

**Sympt√¥me** :
```
django.db.utils.OperationalError: could not connect to server
```

**Solution** :
```bash
# Attendre que DB soit pr√™t
docker compose -f infra/docker/docker-compose.local-prod.yml logs db

# V√©rifier healthcheck DB
docker compose -f infra/docker/docker-compose.local-prod.yml ps db

# R√©ex√©cuter migrations
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend python manage.py migrate
```

### Probl√®me 4 : OCR ne fonctionne pas

**Sympt√¥me** :
```
tesseract: command not found
```

**Solution** :
```bash
# V√©rifier Tesseract install√©
docker compose -f infra/docker/docker-compose.local-prod.yml exec backend tesseract --version

# Si absent, rebuild image
docker compose -f infra/docker/docker-compose.local-prod.yml build --no-cache backend
docker compose -f infra/docker/docker-compose.local-prod.yml up -d backend
```

### Probl√®me 5 : Upload PDF √©choue (413)

**Sympt√¥me** :
```
413 Request Entity Too Large
```

**Solution** :
```nginx
# Modifier infra/nginx/nginx.conf
server {
    client_max_body_size 200M;  # Augmenter √† 200 MB
    ...
}

# Red√©marrer nginx
docker compose -f infra/docker/docker-compose.local-prod.yml restart nginx
```

---

## üìä V√©rification Finale

### Checklist Installation

- [ ] Docker et Docker Compose install√©s
- [ ] Repository clon√©
- [ ] Fichiers .env cr√©√©s
- [ ] Images Docker build√©es
- [ ] Services d√©marr√©s (tous UP et healthy)
- [ ] Migrations appliqu√©es
- [ ] Superuser cr√©√©
- [ ] Donn√©es de test seed√©es
- [ ] Health checks OK (live + ready)
- [ ] Login admin fonctionne
- [ ] Frontend accessible (http://localhost:8088)
- [ ] Django Admin accessible (http://localhost:8088/admin/)
- [ ] Tests backend passent (optionnel)

### Commande de V√©rification Compl√®te

```bash
#!/bin/bash
# verify_installation.sh

echo "üîç V√©rification installation Korrigo..."

# 1. Services
echo "1Ô∏è‚É£ Services Docker..."
docker compose -f infra/docker/docker-compose.local-prod.yml ps

# 2. Health checks
echo "2Ô∏è‚É£ Health checks..."
curl -s http://localhost:8088/api/health/live/ | jq
curl -s http://localhost:8088/api/health/ready/ | jq

# 3. Login test
echo "3Ô∏è‚É£ Test login..."
curl -s -X POST http://localhost:8088/api/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"test_admin","password":"admin123"}' | jq

# 4. Database
echo "4Ô∏è‚É£ Database..."
docker compose -f infra/docker/docker-compose.local-prod.yml exec -T db psql -U korrigo_user -d korrigo_db -c "SELECT COUNT(*) FROM auth_user;"

echo "‚úÖ V√©rification termin√©e"
```

---

## üìù Conclusion

Votre installation locale de Korrigo est maintenant **op√©rationnelle** !

### Prochaines √âtapes

1. **Tester les fonctionnalit√©s** :
   - Cr√©er un examen
   - Upload PDF + CSV
   - Tester OCR
   - Corriger copie
   - Consulter r√©sultats

2. **D√©veloppement** :
   - Utiliser `docker-compose.dev.yml` pour hot reload
   - Configurer IDE (VS Code, PyCharm)
   - Activer debugger

3. **Production** :
   - Voir [06.3-Deploiement-Production.md](./06.3-Deploiement-Production.md)
   - Configurer SSL/TLS
   - Optimiser performances

### Support

En cas de probl√®me :
- Consulter [GUIDE-REFERENCE-RAPIDE.md](../GUIDE-REFERENCE-RAPIDE.md)
- V√©rifier logs : `docker compose logs -f`
- GitHub Issues : https://github.com/your-org/korrigo/issues

---

**Document r√©dig√© par :**
**Alaeddine BEN RHOUMA**
*Lead Senior Documentation & Architecture*
Date : 3 F√©vrier 2026
