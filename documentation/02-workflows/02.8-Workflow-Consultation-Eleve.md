# 02.8 - Workflow Consultation Ã‰lÃ¨ve

**Projet** : Korrigo - SystÃ¨me de Correction d'Examens
**Version** : 2.0 (PRD-19)
**Date** : 3 FÃ©vrier 2026
**Auteur** : **Alaeddine BEN RHOUMA**

---

## ğŸ¯ Objectif

Ce workflow dÃ©crit le processus de **consultation des rÃ©sultats par les Ã©tudiants** :
1. Authentification avec email + date de naissance
2. Consultation des copies publiÃ©es
3. Visualisation dÃ©tails (notes par question, commentaires)
4. TÃ©lÃ©chargement du PDF corrigÃ©
5. Statistiques personnelles

---

## ğŸ“‹ Vue d'Ensemble

### Principe

Les Ã©tudiants accÃ¨dent Ã  un **portail dÃ©diÃ©** sans compte utilisateur Django :
- **Login** : Email + Date de naissance (pas de mot de passe)
- **Session** : Cookie Django avec `student_id`
- **AccÃ¨s** : Uniquement copies publiÃ©es (status=PUBLISHED)
- **Lecture seule** : Pas de modification possible

---

## ğŸ”„ Diagramme Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 WORKFLOW CONSULTATION Ã‰LÃˆVE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ã‰tudiant   â”‚
â”‚   ReÃ§oit     â”‚
â”‚   Email      â”‚
â”‚  "RÃ©sultats  â”‚
â”‚  Disponibles"â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Page Login      â”‚
â”‚  Email +         â”‚ â—„â”€â”€â”€ Si erreur: 401 Unauthorized
â”‚  Date Naissance  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Validation      â”‚
â”‚  Student.get()   â”‚
â”‚  email + DOB     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CrÃ©ation        â”‚
â”‚  Session Django  â”‚
â”‚  student_id      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard       â”‚
â”‚  - Liste copies  â”‚
â”‚  - Statistiques  â”‚
â”‚  - Moyenne       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚             â”‚
       â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DÃ©tails     â”‚ â”‚ TÃ©lÃ©charger â”‚ â”‚ Statistiquesâ”‚
â”‚ Copie       â”‚ â”‚ PDF         â”‚ â”‚ Globales    â”‚
â”‚ (notes +    â”‚ â”‚             â”‚ â”‚             â”‚
â”‚ commentairesâ”‚ â”‚             â”‚ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ã‰tapes DÃ©taillÃ©es

### Ã‰tape 1 : Notification par Email

**DÃ©clencheur** : Enseignant publie rÃ©sultats (`/api/exams/{id}/publish_results/`)

**Email EnvoyÃ©** :

```
De: noreply@korrigo.local
Ã€: jean.dupont@korrigo.local
Sujet: RÃ©sultats disponibles - Ã‰valuation Loi Binomiale

Bonjour Jean,

Vos rÃ©sultats pour l'examen "Ã‰valuation Loi Binomiale" sont maintenant disponibles.

Note : 15.5 / 20.0

Connectez-vous pour consulter votre copie corrigÃ©e :
https://korrigo.korrigo.local/student/login

Cordialement,
L'Ã©quipe enseignante
```

**Code Backend** :

```python
# exams/views.py

from django.core.mail import send_mass_mail

def _send_result_notifications(self, exam):
    """Envoyer emails aux Ã©tudiants."""
    copies = Copy.objects.filter(
        exam=exam,
        status='PUBLISHED'
    ).select_related('student')

    emails = []
    for copy in copies:
        if copy.student and copy.student.email:
            subject = f"RÃ©sultats disponibles - {exam.title}"
            message = f"""
Bonjour {copy.student.first_name},

Vos rÃ©sultats pour l'examen "{exam.title}" sont maintenant disponibles.

Note : {copy.total_score} / {copy.max_score}

Connectez-vous pour consulter votre copie corrigÃ©e :
https://korrigo.korrigo.local/student/login

Cordialement,
L'Ã©quipe enseignante
            """.strip()

            emails.append((
                subject,
                message,
                'noreply@korrigo.local',
                [copy.student.email]
            ))

    # Envoi batch
    send_mass_mail(emails, fail_silently=False)

    logger.info(f"Sent {len(emails)} result notifications for exam {exam.id}")
```

---

### Ã‰tape 2 : Login Ã‰tudiant

**URL** : `/student/login`

**Interface** : `StudentLogin.vue`

```vue
<template>
  <div class="student-login">
    <div class="login-card">
      <h1>ğŸ“ Portail Ã‰lÃ¨ve - Korrigo</h1>
      <p class="subtitle">Consultez vos rÃ©sultats d'examens</p>

      <form @submit.prevent="handleLogin">
        <!-- Email -->
        <div class="form-group">
          <label for="email">ğŸ“§ Email</label>
          <input
            id="email"
            v-model="email"
            type="email"
            placeholder="jean.dupont@korrigo.local"
            required
            autofocus
          />
        </div>

        <!-- Date de Naissance -->
        <div class="form-group">
          <label for="dob">ğŸ‚ Date de Naissance</label>
          <input
            id="dob"
            v-model="dateOfBirth"
            type="text"
            placeholder="JJ/MM/AAAA (ex: 15/05/2008)"
            pattern="\d{2}/\d{2}/\d{4}"
            required
          />
          <p class="help-text">Format : JJ/MM/AAAA</p>
        </div>

        <!-- Erreur -->
        <div v-if="error" class="error-message">
          âŒ {{ error }}
        </div>

        <!-- Submit -->
        <button type="submit" :disabled="loading" class="btn-login">
          {{ loading ? 'Connexion...' : 'Se Connecter' }}
        </button>
      </form>

      <!-- Aide -->
      <div class="help-section">
        <p>
          ğŸ’¡ <strong>PremiÃ¨re visite ?</strong><br>
          Utilisez l'email et la date de naissance que vous avez fournis Ã  votre enseignant.
        </p>
        <p>
          ğŸ”’ Vos donnÃ©es sont sÃ©curisÃ©es et confidentielles.
        </p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { studentApi } from '@/services/studentApi'

const router = useRouter()

const email = ref('')
const dateOfBirth = ref('')
const loading = ref(false)
const error = ref('')

async function handleLogin() {
  loading.value = true
  error.value = ''

  try {
    await studentApi.login({
      email: email.value,
      date_of_birth: dateOfBirth.value
    })

    // Rediriger vers dashboard
    router.push('/student/dashboard')

  } catch (err: any) {
    if (err.response?.status === 401) {
      error.value = 'Email ou date de naissance incorrects'
    } else {
      error.value = 'Erreur de connexion. RÃ©essayez.'
    }
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
.student-login {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.login-card {
  background: white;
  padding: 3rem;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
  max-width: 450px;
  width: 100%;
}

h1 {
  margin-bottom: 0.5rem;
  color: #333;
  font-size: 2rem;
}

.subtitle {
  color: #666;
  margin-bottom: 2rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #333;
}

input {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
}

input:focus {
  outline: none;
  border-color: #667eea;
}

.help-text {
  font-size: 0.85rem;
  color: #666;
  margin-top: 0.25rem;
}

.error-message {
  background: #fee;
  color: #c33;
  padding: 0.75rem;
  border-radius: 6px;
  margin-bottom: 1rem;
}

.btn-login {
  width: 100%;
  padding: 1rem;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s;
}

.btn-login:hover:not(:disabled) {
  background: #5568d3;
}

.btn-login:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.help-section {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid #e0e0e0;
  font-size: 0.9rem;
  color: #666;
}
</style>
```

**API Backend** : `POST /api/students/login/`

```python
# students/views.py

from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny
from rest_framework.response import Response
from rest_framework import status
from django.utils import timezone
from datetime import datetime
from .models import Student
from .serializers import StudentSerializer
import logging

logger = logging.getLogger(__name__)

@api_view(['POST'])
@permission_classes([AllowAny])
def student_login(request):
    """
    Login Ã©tudiant avec email + date de naissance.

    Request:
        {
            "email": "jean.dupont@korrigo.local",
            "date_of_birth": "15/05/2008"
        }

    Response (200):
        {
            "success": true,
            "student": {...},
            "session_expires_at": "2026-02-03T18:30:00Z"
        }
    """
    email = request.data.get('email')
    date_of_birth = request.data.get('date_of_birth')

    if not email or not date_of_birth:
        return Response(
            {'error': 'Email and date_of_birth required'},
            status=status.HTTP_400_BAD_REQUEST
        )

    # Parser date (DD/MM/YYYY ou YYYY-MM-DD)
    try:
        if '/' in date_of_birth:
            dob = datetime.strptime(date_of_birth, '%d/%m/%Y').date()
        else:
            dob = datetime.strptime(date_of_birth, '%Y-%m-%d').date()
    except ValueError:
        return Response(
            {'error': 'Invalid date format. Use DD/MM/YYYY or YYYY-MM-DD'},
            status=status.HTTP_400_BAD_REQUEST
        )

    # Chercher Ã©tudiant
    try:
        student = Student.objects.get(
            email__iexact=email,
            date_of_birth=dob
        )
    except Student.DoesNotExist:
        logger.warning(f"Failed login attempt for email: {email}")
        return Response(
            {'error': 'Invalid credentials'},
            status=status.HTTP_401_UNAUTHORIZED
        )

    # CrÃ©er session
    request.session['student_id'] = student.id
    request.session['is_student'] = True
    request.session.set_expiry(3600 * 2)  # 2 heures

    logger.info(f"Student {student.id} ({student.email}) logged in")

    return Response({
        'success': True,
        'student': StudentSerializer(student).data,
        'session_expires_at': timezone.now() + timezone.timedelta(hours=2)
    })
```

---

### Ã‰tape 3 : Dashboard Ã‰tudiant

**URL** : `/student/dashboard`

**Interface** : `StudentDashboard.vue`

```vue
<template>
  <div class="student-dashboard">
    <!-- Header -->
    <header class="dashboard-header">
      <div class="user-info">
        <h1>Bienvenue {{ profile?.first_name }} {{ profile?.last_name }}</h1>
        <p class="email">{{ profile?.email }}</p>
      </div>

      <button @click="handleLogout" class="btn-logout">
        ğŸšª DÃ©connexion
      </button>
    </header>

    <!-- Statistiques Globales -->
    <section class="stats-overview">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-content">
          <h3>{{ statistics?.overall.published_exams || 0 }}</h3>
          <p>Examens PubliÃ©s</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-content">
          <h3>{{ statistics?.overall.average_percentage?.toFixed(1) || 0 }}%</h3>
          <p>Moyenne GÃ©nÃ©rale</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">â³</div>
        <div class="stat-content">
          <h3>{{ statistics?.overall.pending_exams || 0 }}</h3>
          <p>En Attente</p>
        </div>
      </div>
    </section>

    <!-- Liste Copies -->
    <section class="copies-section">
      <h2>ğŸ“š Mes Examens</h2>

      <div v-if="copies.length === 0" class="empty-state">
        <p>Aucun examen publiÃ© pour le moment.</p>
        <p>Vous recevrez un email dÃ¨s que vos rÃ©sultats seront disponibles.</p>
      </div>

      <div v-else class="copies-grid">
        <div
          v-for="copy in copies"
          :key="copy.id"
          class="copy-card"
          :class="{ 'good-grade': copy.percentage >= 75 }"
        >
          <!-- Header -->
          <div class="copy-header">
            <h3>{{ copy.exam.title }}</h3>
            <span class="subject-badge">{{ copy.exam.subject }}</span>
          </div>

          <!-- Date -->
          <div class="copy-date">
            ğŸ“… {{ formatDate(copy.exam.date) }}
          </div>

          <!-- Score -->
          <div class="copy-score">
            <div class="score-display">
              <span class="score">{{ copy.total_score }}</span>
              <span class="separator">/</span>
              <span class="max-score">{{ copy.max_score }}</span>
            </div>

            <div class="percentage-badge" :class="getGradeClass(copy.percentage)">
              {{ copy.percentage }}%
            </div>
          </div>

          <!-- Actions -->
          <div class="copy-actions">
            <button @click="viewCopyDetails(copy.id)" class="btn-view">
              ğŸ‘ï¸ Voir DÃ©tails
            </button>

            <button @click="downloadPDF(copy)" class="btn-download">
              ğŸ“¥ TÃ©lÃ©charger PDF
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Statistiques par MatiÃ¨re -->
    <section v-if="statistics?.by_subject?.length > 0" class="subject-stats">
      <h2>ğŸ“Š Statistiques par MatiÃ¨re</h2>

      <div class="subjects-grid">
        <div
          v-for="subject in statistics.by_subject"
          :key="subject.subject"
          class="subject-card"
        >
          <h3>{{ subject.subject }}</h3>

          <div class="subject-metrics">
            <div class="metric">
              <label>Moyenne</label>
              <span class="value">{{ subject.average_percentage.toFixed(1) }}%</span>
            </div>

            <div class="metric">
              <label>Examens</label>
              <span class="value">{{ subject.exam_count }}</span>
            </div>

            <div class="metric">
              <label>Meilleure note</label>
              <span class="value">{{ subject.best_score }} / 20</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { studentApi } from '@/services/studentApi'

const router = useRouter()

const profile = ref(null)
const statistics = ref(null)
const copies = ref([])

onMounted(async () => {
  await loadData()
})

async function loadData() {
  try {
    profile.value = await studentApi.getProfile()
    statistics.value = await studentApi.getStatistics()
    copies.value = await studentApi.getCopies()
  } catch (error) {
    console.error('Error loading data:', error)
    if (error.response?.status === 401) {
      router.push('/student/login')
    }
  }
}

function viewCopyDetails(copyId: number) {
  router.push(`/student/copies/${copyId}`)
}

async function downloadPDF(copy: any) {
  const filename = `${copy.exam.title.replace(/\s+/g, '_')}_${copy.anonymous_id}.pdf`
  await studentApi.downloadPDF(copy.id, filename)
}

async function handleLogout() {
  await studentApi.logout()
  router.push('/student/login')
}

function formatDate(dateStr: string): string {
  const date = new Date(dateStr)
  return date.toLocaleDateString('fr-FR', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  })
}

function getGradeClass(percentage: number): string {
  if (percentage >= 75) return 'excellent'
  if (percentage >= 60) return 'good'
  if (percentage >= 50) return 'average'
  return 'poor'
}
</script>

<style scoped>
.student-dashboard {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid #e0e0e0;
}

.user-info h1 {
  margin: 0 0 0.5rem 0;
  color: #333;
}

.email {
  color: #666;
  margin: 0;
}

.btn-logout {
  padding: 0.75rem 1.5rem;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 3rem;
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.stat-icon {
  font-size: 3rem;
}

.stat-content h3 {
  margin: 0 0 0.25rem 0;
  font-size: 2rem;
  color: #667eea;
}

.stat-content p {
  margin: 0;
  color: #666;
}

.copies-section h2,
.subject-stats h2 {
  margin-bottom: 1.5rem;
  color: #333;
}

.copies-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 1.5rem;
}

.copy-card {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

.copy-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.copy-card.good-grade {
  border-left: 4px solid #4caf50;
}

.copy-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1rem;
}

.copy-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.2rem;
}

.subject-badge {
  background: #667eea;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.85rem;
}

.copy-date {
  color: #666;
  margin-bottom: 1rem;
}

.copy-score {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 1.5rem 0;
}

.score-display {
  font-size: 2rem;
  font-weight: bold;
}

.score {
  color: #667eea;
}

.separator {
  color: #999;
  margin: 0 0.5rem;
}

.max-score {
  color: #999;
}

.percentage-badge {
  padding: 0.5rem 1rem;
  border-radius: 8px;
  font-weight: bold;
  font-size: 1.1rem;
}

.percentage-badge.excellent {
  background: #e8f5e9;
  color: #2e7d32;
}

.percentage-badge.good {
  background: #e3f2fd;
  color: #1565c0;
}

.percentage-badge.average {
  background: #fff3e0;
  color: #e65100;
}

.percentage-badge.poor {
  background: #ffebee;
  color: #c62828;
}

.copy-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

.btn-view,
.btn-download {
  padding: 0.75rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}

.btn-view {
  background: #667eea;
  color: white;
}

.btn-view:hover {
  background: #5568d3;
}

.btn-download {
  background: #f0f0f0;
  color: #333;
}

.btn-download:hover {
  background: #e0e0e0;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: #666;
}

.subjects-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.subject-card {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.subject-card h3 {
  margin: 0 0 1rem 0;
  color: #667eea;
}

.subject-metrics {
  display: flex;
  justify-content: space-between;
}

.metric {
  text-align: center;
}

.metric label {
  display: block;
  font-size: 0.85rem;
  color: #666;
  margin-bottom: 0.25rem;
}

.metric .value {
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;
}
</style>
```

---

### Ã‰tape 4 : DÃ©tails Copie

**URL** : `/student/copies/{id}`

**Interface** : Afficher notes par question + commentaires

```vue
<template>
  <div class="copy-details">
    <!-- Header -->
    <header class="details-header">
      <button @click="router.back()" class="btn-back">
        â† Retour
      </button>

      <h1>{{ copy?.exam.title }}</h1>

      <button @click="downloadPDF" class="btn-download-large">
        ğŸ“¥ TÃ©lÃ©charger PDF
      </button>
    </header>

    <!-- Score Global -->
    <div class="global-score">
      <div class="score-display">
        <span class="score">{{ copy?.total_score }}</span>
        <span>/</span>
        <span class="max">{{ copy?.max_score }}</span>
      </div>

      <div class="percentage" :class="getGradeClass(copy?.percentage)">
        {{ copy?.percentage }}%
      </div>
    </div>

    <!-- Commentaire Global -->
    <div v-if="copy?.teacher_comment" class="global-comment">
      <h3>ğŸ’¬ Commentaire GÃ©nÃ©ral</h3>
      <p>{{ copy.teacher_comment }}</p>
    </div>

    <!-- Notes par Question -->
    <section class="questions-grades">
      <h2>ğŸ“ Notes par Question</h2>

      <div
        v-for="grade in copy?.grades"
        :key="grade.question_number"
        class="question-grade"
      >
        <div class="question-header">
          <h3>Question {{ grade.question_number }}: {{ grade.question_title }}</h3>

          <div class="grade-score">
            <span class="score">{{ grade.score }}</span>
            <span class="separator">/</span>
            <span class="max">{{ grade.max_score }}</span>
          </div>
        </div>

        <div v-if="grade.comment" class="grade-comment">
          <strong>Commentaire:</strong> {{ grade.comment }}
        </div>
      </div>
    </section>

    <!-- PDF Viewer -->
    <section class="pdf-viewer-section">
      <h2>ğŸ“„ Copie CorrigÃ©e</h2>

      <iframe
        :src="`/api/students/copies/${copyId}/pdf/`"
        width="100%"
        height="800px"
        style="border: 1px solid #ddd; border-radius: 8px;"
      ></iframe>
    </section>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { studentApi } from '@/services/studentApi'

const router = useRouter()
const props = defineProps<{ copyId: number }>()

const copy = ref(null)

onMounted(async () => {
  copy.value = await studentApi.getCopyDetail(props.copyId)
})

async function downloadPDF() {
  const filename = `copie_${copy.value.anonymous_id}.pdf`
  await studentApi.downloadPDF(props.copyId, filename)
}

function getGradeClass(percentage: number): string {
  if (percentage >= 75) return 'excellent'
  if (percentage >= 60) return 'good'
  if (percentage >= 50) return 'average'
  return 'poor'
}
</script>
```

---

### Ã‰tape 5 : TÃ©lÃ©chargement PDF

**API** : `GET /api/students/copies/{id}/pdf/`

**Backend** :

```python
# students/views.py

@action(detail=True, methods=['get'])
def pdf(self, request, pk=None):
    """TÃ©lÃ©charger PDF copie corrigÃ©e."""
    copy = self.get_object()

    # VÃ©rifier ownership
    student_id = request.session.get('student_id')
    if copy.student_id != student_id:
        return Response(
            {'error': 'Access denied'},
            status=status.HTTP_403_FORBIDDEN
        )

    # VÃ©rifier publication
    if copy.status != 'PUBLISHED':
        return Response(
            {'error': 'Copy not yet published'},
            status=status.HTTP_403_FORBIDDEN
        )

    # VÃ©rifier PDF existe
    if not copy.pdf_file:
        return Response(
            {'error': 'PDF not found'},
            status=status.HTTP_404_NOT_FOUND
        )

    # Retourner fichier
    filename = f"copie_{copy.anonymous_id}_{copy.student.last_name}_{copy.student.first_name}.pdf"

    return FileResponse(
        copy.pdf_file.open('rb'),
        as_attachment=True,
        filename=filename,
        content_type='application/pdf'
    )
```

---

## ğŸ” SÃ©curitÃ©

### Authentification Sans Mot de Passe

**Risques** :
- âš ï¸ Date de naissance = information semi-publique
- âš ï¸ Brute-force possible

**Mitigations** :
- âœ… Rate limiting (5 tentatives / minute)
- âœ… Session courte (2 heures)
- âœ… AccÃ¨s lecture seule
- âœ… Copies publiÃ©es uniquement
- âœ… Logs des tentatives Ã©chouÃ©es

**Rate Limiting** :

```python
# students/views.py

from django_ratelimit.decorators import ratelimit

@ratelimit(key='ip', rate='5/m', method='POST')
@api_view(['POST'])
@permission_classes([AllowAny])
def student_login(request):
    """Login limitÃ© Ã  5 tentatives par minute."""
    # ...
```

### Permissions

```python
# core/permissions.py

from rest_framework.permissions import BasePermission

class IsStudent(BasePermission):
    """Permission pour vÃ©rifier session Ã©tudiant."""

    def has_permission(self, request, view):
        """VÃ©rifier session Ã©tudiant."""
        return bool(
            request.session and
            request.session.get('is_student') and
            request.session.get('student_id')
        )

    def has_object_permission(self, request, view, obj):
        """VÃ©rifier que copie appartient Ã  l'Ã©tudiant."""
        student_id = request.session.get('student_id')

        if hasattr(obj, 'student_id'):
            return obj.student_id == student_id

        return False
```

---

## âœ… Tests

### Test Login

```python
# students/tests/test_auth.py

from django.test import TestCase
from rest_framework.test import APIClient
from students.models import Student
from datetime import date

class StudentLoginTestCase(TestCase):
    def setUp(self):
        self.client = APIClient()

        self.student = Student.objects.create(
            first_name='Jean',
            last_name='DUPONT',
            email='jean.dupont@korrigo.local',
            date_of_birth=date(2008, 5, 15)
        )

    def test_login_success(self):
        """Test login valide."""
        response = self.client.post('/api/students/login/', {
            'email': 'jean.dupont@korrigo.local',
            'date_of_birth': '15/05/2008'
        })

        self.assertEqual(response.status_code, 200)
        self.assertTrue(response.data['success'])

        # VÃ©rifier session
        session = self.client.session
        self.assertEqual(session['student_id'], self.student.id)

    def test_login_invalid_credentials(self):
        """Test login avec mauvais credentials."""
        response = self.client.post('/api/students/login/', {
            'email': 'jean.dupont@korrigo.local',
            'date_of_birth': '01/01/2000'  # Mauvaise date
        })

        self.assertEqual(response.status_code, 401)

    def test_access_published_copy(self):
        """Test accÃ¨s copie publiÃ©e."""
        # Login
        self.client.post('/api/students/login/', {
            'email': 'jean.dupont@korrigo.local',
            'date_of_birth': '15/05/2008'
        })

        # CrÃ©er copie publiÃ©e
        copy = Copy.objects.create(
            exam=self.exam,
            student=self.student,
            status='PUBLISHED',
            total_score=15.0,
            max_score=20.0
        )

        # RÃ©cupÃ©rer copie
        response = self.client.get(f'/api/students/copies/{copy.id}/')

        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data['total_score'], 15.0)

    def test_cannot_access_unpublished_copy(self):
        """Test accÃ¨s refusÃ© copie non publiÃ©e."""
        # Login
        self.client.post('/api/students/login/', {
            'email': 'jean.dupont@korrigo.local',
            'date_of_birth': '15/05/2008'
        })

        # CrÃ©er copie GRADED (non publiÃ©e)
        copy = Copy.objects.create(
            exam=self.exam,
            student=self.student,
            status='GRADED'
        )

        # Tenter accÃ¨s
        response = self.client.get(f'/api/students/copies/{copy.id}/')

        self.assertEqual(response.status_code, 403)
```

---

## ğŸ“ Conclusion

Le workflow de consultation Ã©lÃ¨ve offre une interface simple et intuitive pour consulter les rÃ©sultats. L'authentification email + date de naissance Ã©vite la gestion de comptes utilisateurs tout en restant suffisamment sÃ©curisÃ©e pour un contexte Ã©ducatif.

**Points clÃ©s** :
- Authentification sans mot de passe (email + DOB)
- Dashboard avec statistiques globales
- DÃ©tails copies avec notes par question
- TÃ©lÃ©chargement PDF sÃ©curisÃ©
- Rate limiting et sessions courtes
- Interface responsive et accessible

---

**Document rÃ©digÃ© par :**
**Alaeddine BEN RHOUMA**
*Lead Senior Documentation & Architecture*
Date : 3 FÃ©vrier 2026
