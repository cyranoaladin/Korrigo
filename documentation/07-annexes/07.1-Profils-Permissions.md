# 07.1 - Profils Utilisateurs et Permissions

**Projet** : Korrigo - SystÃ¨me de Correction d'Examens
**Version** : 2.0 (PRD-19)
**Date** : 3 FÃ©vrier 2026
**Auteur** : **Alaeddine BEN RHOUMA**

---

## ğŸ¯ Vue d'Ensemble

Korrigo gÃ¨re **3 profils utilisateurs principaux** avec des permissions granulaires basÃ©es sur le systÃ¨me de permissions Django.

### HiÃ©rarchie des Profils

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ADMIN (Superuser)           â”‚
â”‚   â€¢ AccÃ¨s complet                   â”‚
â”‚   â€¢ Gestion utilisateurs            â”‚
â”‚   â€¢ Toutes opÃ©rations               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TEACHER         â”‚  â”‚  STUDENT         â”‚
â”‚  â€¢ is_staff=True â”‚  â”‚  â€¢ is_staff=Falseâ”‚
â”‚  â€¢ Correction    â”‚  â”‚  â€¢ Consultation  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¤ Profil 1 : Admin (Administrateur)

### CaractÃ©ristiques

- **Django** : `is_superuser=True`, `is_staff=True`
- **Groupes** : `admin`, `teacher` (hÃ©rite permissions enseignant)
- **AccÃ¨s** : Complet sur toutes les ressources

### Permissions

| Permission | Description |
|------------|-------------|
| âœ… **create_exam** | CrÃ©er un examen |
| âœ… **delete_exam** | Supprimer un examen |
| âœ… **upload_scans** | Upload PDF et CSV |
| âœ… **assign_corrector** | Assigner correcteurs aux copies |
| âœ… **manage_users** | CrÃ©er/modifier/supprimer utilisateurs |
| âœ… **view_all_copies** | Voir toutes les copies (tous examens) |
| âœ… **grade_any_copy** | Corriger n'importe quelle copie |
| âœ… **finalize_exam** | Publier rÃ©sultats |
| âœ… **export_results** | Exporter statistiques |
| âœ… **access_django_admin** | AccÃ¨s Django Admin (`/admin/`) |
| âœ… **unlock_copy** | DÃ©verrouiller copie verrouillÃ©e |
| âœ… **override_identification** | Forcer identification manuelle |

### Workflows AutorisÃ©s

1. **CrÃ©ation d'Examen** :
   - CrÃ©er examen
   - Upload PDF + CSV
   - Lancer traitement batch
   - GÃ©rer identification des copies
   - Assigner correcteurs

2. **Correction** :
   - Corriger toutes les copies (assignÃ©es ou non)
   - DÃ©verrouiller copies finalisÃ©es

3. **Gestion Utilisateurs** :
   - CrÃ©er comptes enseignants
   - CrÃ©er comptes Ã©tudiants
   - RÃ©initialiser mots de passe
   - GÃ©rer groupes et permissions

4. **Finalisation** :
   - Publier rÃ©sultats
   - Exporter statistiques
   - Archiver examens

### Comptes de Test

```
Username:  test_admin
Password:  admin123
Email:     admin@korrigo.tn
```

### Exemple Code VÃ©rification

```python
# Backend
def is_admin(user):
    return user.is_authenticated and user.is_superuser

# Vue Django
@user_passes_test(is_admin)
def admin_only_view(request):
    ...

# DRF API
from core.permissions import IsAdmin

@permission_classes([IsAdmin])
def admin_api_view(request):
    ...
```

```typescript
// Frontend
const authStore = useAuthStore()

if (authStore.isAdmin) {
  // Afficher menu admin
}
```

---

## ğŸ‘¨â€ğŸ« Profil 2 : Teacher (Enseignant)

### CaractÃ©ristiques

- **Django** : `is_staff=True`, `is_superuser=False`
- **Groupes** : `teacher`
- **AccÃ¨s** : LimitÃ© aux copies assignÃ©es

### Permissions

| Permission | Description |
|------------|-------------|
| âœ… **view_assigned_copies** | Voir ses copies assignÃ©es uniquement |
| âœ… **grade_copies** | Corriger copies assignÃ©es |
| âœ… **annotate_copies** | Ajouter annotations PDF |
| âœ… **lock_copy** | Verrouiller copie aprÃ¨s correction |
| âœ… **select_ocr_candidate** | SÃ©lectionner candidat (mode SEMI-AUTO) |
| âœ… **manual_assign_student** | Assignation manuelle (mode MANUAL) |
| âœ… **view_exam_details** | Voir dÃ©tails examens assignÃ©s |
| âŒ **create_exam** | âŒ Ne peut pas crÃ©er examen |
| âŒ **assign_corrector** | âŒ Ne peut pas assigner correcteurs |
| âŒ **finalize_exam** | âŒ Ne peut pas publier rÃ©sultats |
| âŒ **access_django_admin** | âŒ Pas d'accÃ¨s Django Admin |
| âŒ **unlock_copy** | âŒ Ne peut pas dÃ©verrouiller copie finalisÃ©e |

### Workflows AutorisÃ©s

1. **Correction** :
   - Lister ses copies assignÃ©es
   - Ouvrir copie
   - Annoter PDF
   - Attribuer notes par question
   - Sauvegarder (auto-save)
   - Finaliser et verrouiller

2. **Identification** (si copies non identifiÃ©es) :
   - Voir candidats OCR (mode SEMI-AUTO)
   - SÃ©lectionner bon Ã©tudiant parmi top-5
   - Rechercher manuellement (mode MANUAL)

### Restrictions

- **Ne peut pas** :
  - Voir copies d'autres correcteurs
  - Modifier copie verrouillÃ©e
  - CrÃ©er/supprimer examens
  - GÃ©rer utilisateurs
  - Publier rÃ©sultats

### Comptes de Test

```
Username:  test_prof
Password:  prof123
Email:     prof@korrigo.tn

Username:  prof1, prof2, prof3
Password:  &@NB6]9gT.&UX`r5|@1ip/s#
```

### Exemple Code VÃ©rification

```python
# Backend
def is_teacher(user):
    return user.is_authenticated and user.is_staff

# DRF Permission
class IsTeacher(BasePermission):
    def has_permission(self, request, view):
        return request.user.is_authenticated and request.user.is_staff

# VÃ©rifier propriÃ©tÃ© copie
class IsAssignedCorrector(BasePermission):
    def has_object_permission(self, request, view, obj):
        # obj = Copy
        return obj.corrector == request.user or request.user.is_superuser
```

```typescript
// Frontend
const authStore = useAuthStore()

if (authStore.isTeacher) {
  // Afficher dashboard enseignant
}

// Route guard
{
  path: '/teacher/copies/:id',
  meta: { requiresAuth: true, requiresRole: 'teacher' }
}
```

---

## ğŸ‘¨â€ğŸ“ Profil 3 : Student (Ã‰tudiant)

### CaractÃ©ristiques

- **Django** : `is_staff=False`, `is_superuser=False`
- **Groupes** : Aucun
- **AccÃ¨s** : Consultation rÃ©sultats uniquement
- **Authentification** : 2 mÃ©thodes
  - Standard : `username` + `password`
  - Alternative : `email` + `date_of_birth`

### Permissions

| Permission | Description |
|------------|-------------|
| âœ… **view_own_results** | Voir ses propres rÃ©sultats |
| âœ… **view_own_copies** | Voir ses copies corrigÃ©es (publiÃ©es) |
| âœ… **download_copy_pdf** | TÃ©lÃ©charger PDF de sa copie |
| âŒ **view_others_copies** | âŒ Ne peut pas voir copies d'autres Ã©tudiants |
| âŒ **grade_copies** | âŒ Ne peut pas corriger |
| âŒ **create_exam** | âŒ Ne peut pas crÃ©er examen |
| âŒ **access_admin** | âŒ Aucun accÃ¨s admin |

### Workflows AutorisÃ©s

1. **Authentification** :
   - Login via email + date de naissance
   - OU login standard (si User crÃ©Ã©)

2. **Consultation** :
   - Liste de ses examens
   - Voir copie corrigÃ©e (si publiÃ©e)
   - Voir notes par question
   - Voir annotations enseignant
   - TÃ©lÃ©charger PDF

### Restrictions

- **Ne peut voir que** :
  - Ses propres copies
  - Examens publiÃ©s uniquement
  - Pas d'accÃ¨s pendant correction

- **Ne peut pas** :
  - Voir copies en cours de correction
  - Modifier quoi que ce soit
  - Voir copies d'autres Ã©tudiants
  - AccÃ©der aux interfaces admin/teacher

### Comptes de Test

```
Username:  test_student
Password:  student123
Email:     test_student@test.local

Username:  eleve1, eleve2, ..., eleve10
Password:  eleve2025
Email:     eleve1@korrigo.local, etc.
```

### Exemple Code VÃ©rification

```python
# Backend
def is_student(user):
    return user.is_authenticated and not user.is_staff

# DRF Permission
class IsStudent(BasePermission):
    def has_permission(self, request, view):
        return request.user.is_authenticated and not request.user.is_staff

# VÃ©rifier propriÃ©tÃ© copie
class IsOwnCopy(BasePermission):
    def has_object_permission(self, request, view, obj):
        # obj = Copy
        if request.user.is_staff:
            return True  # Admin/Teacher peut voir
        return obj.student and obj.student.user == request.user
```

```typescript
// Frontend
const authStore = useAuthStore()

if (authStore.isStudent) {
  // Afficher portail Ã©tudiant
}

// Route guard
{
  path: '/student/copies/:id',
  meta: { requiresAuth: true, requiresRole: 'student' }
}
```

---

## ğŸ“Š Matrice des Permissions ComplÃ¨te

### Actions sur les Examens

| Action | Admin | Teacher | Student |
|--------|:-----:|:-------:|:-------:|
| CrÃ©er examen | âœ… | âŒ | âŒ |
| Voir examen | âœ… | âœ… (assignÃ©) | âœ… (publiÃ©) |
| Modifier examen | âœ… | âŒ | âŒ |
| Supprimer examen | âœ… | âŒ | âŒ |
| Upload PDF/CSV | âœ… | âŒ | âŒ |
| Assigner correcteurs | âœ… | âŒ | âŒ |
| Publier rÃ©sultats | âœ… | âŒ | âŒ |

### Actions sur les Copies

| Action | Admin | Teacher | Student |
|--------|:-----:|:-------:|:-------:|
| Lister copies | âœ… Toutes | âœ… AssignÃ©es | âœ… Propres (publiÃ©es) |
| Voir copie | âœ… | âœ… (assignÃ©e) | âœ… (propre + publiÃ©e) |
| Corriger copie | âœ… | âœ… (assignÃ©e) | âŒ |
| Annoter PDF | âœ… | âœ… (assignÃ©e) | âŒ |
| Verrouiller copie | âœ… | âœ… (assignÃ©e) | âŒ |
| DÃ©verrouiller copie | âœ… | âŒ | âŒ |
| TÃ©lÃ©charger PDF | âœ… | âœ… (assignÃ©e) | âœ… (propre + publiÃ©e) |

### Actions d'Identification

| Action | Admin | Teacher | Student |
|--------|:-----:|:-------:|:-------:|
| Voir candidats OCR | âœ… | âœ… | âŒ |
| SÃ©lectionner candidat (SEMI-AUTO) | âœ… | âœ… | âŒ |
| Assignation manuelle (MANUAL) | âœ… | âœ… | âŒ |
| Forcer rÃ©-identification | âœ… | âŒ | âŒ |

### AccÃ¨s Interfaces

| Interface | Admin | Teacher | Student |
|-----------|:-----:|:-------:|:-------:|
| Django Admin (`/admin/`) | âœ… | âŒ | âŒ |
| Dashboard Admin | âœ… | âŒ | âŒ |
| Dashboard Teacher | âœ… | âœ… | âŒ |
| Portail Ã‰tudiant | âœ… | âœ… | âœ… |
| Interface Correction | âœ… | âœ… | âŒ |
| Bureau Identification | âœ… | âœ… | âŒ |

---

## ğŸ” Groupes Django

### Configuration Groupes

**Fichier** : `backend/core/management/commands/setup_groups.py`

```python
from django.core.management.base import BaseCommand
from django.contrib.auth.models import Group, Permission

class Command(BaseCommand):
    help = 'Setup default groups and permissions'

    def handle(self, *args, **options):
        # Groupe Teacher
        teacher_group, created = Group.objects.get_or_create(name='teacher')

        if created:
            permissions = [
                'view_copy',
                'change_copy',
                'add_grade',
                'change_grade',
                'add_annotation',
                'change_annotation',
            ]

            for perm_code in permissions:
                try:
                    perm = Permission.objects.get(codename=perm_code)
                    teacher_group.permissions.add(perm)
                except Permission.DoesNotExist:
                    self.stdout.write(f'Permission {perm_code} not found')

            self.stdout.write(self.style.SUCCESS('Teacher group created'))

        # Groupe Admin
        admin_group, created = Group.objects.get_or_create(name='admin')

        if created:
            # Admin hÃ©rite toutes permissions teacher
            admin_group.permissions.set(teacher_group.permissions.all())

            # + Permissions admin spÃ©cifiques
            admin_permissions = [
                'add_exam',
                'change_exam',
                'delete_exam',
                'add_user',
                'change_user',
                'delete_user',
            ]

            for perm_code in admin_permissions:
                try:
                    perm = Permission.objects.get(codename=perm_code)
                    admin_group.permissions.add(perm)
                except Permission.DoesNotExist:
                    pass

            self.stdout.write(self.style.SUCCESS('Admin group created'))
```

### Assigner Groupe Ã  Utilisateur

```python
from django.contrib.auth import get_user_model
from django.contrib.auth.models import Group

User = get_user_model()

# CrÃ©er enseignant
teacher = User.objects.create_user(
    username='prof_math',
    password='secure123',
    email='prof.math@korrigo.tn',
    is_staff=True  # IMPORTANT pour enseignant
)

# Assigner groupe
teacher_group = Group.objects.get(name='teacher')
teacher.groups.add(teacher_group)

# VÃ©rifier permissions
teacher.has_perm('exams.view_copy')  # True
teacher.has_perm('exams.delete_exam')  # False
```

---

## ğŸ”’ VÃ©rifications de Permissions

### Backend (DRF ViewSet)

```python
from rest_framework import viewsets
from rest_framework.permissions import IsAuthenticated
from core.permissions import IsTeacher, IsAssignedCorrector

class CopyViewSet(viewsets.ModelViewSet):
    """
    ViewSet avec permissions granulaires.
    """
    permission_classes = [IsAuthenticated]

    def get_permissions(self):
        """Permissions dynamiques selon action."""

        if self.action in ['list', 'retrieve']:
            # Lecture: teacher ou admin
            return [IsAuthenticated(), IsTeacher()]

        elif self.action in ['update', 'partial_update']:
            # Modification: correcteur assignÃ© uniquement
            return [IsAuthenticated(), IsAssignedCorrector()]

        elif self.action == 'destroy':
            # Suppression: admin uniquement
            return [IsAuthenticated(), IsAdmin()]

        return super().get_permissions()

    def get_queryset(self):
        """Filtrer selon profil."""

        user = self.request.user

        if user.is_superuser:
            # Admin voit tout
            return Copy.objects.all()

        elif user.is_staff:
            # Teacher voit ses copies assignÃ©es
            return Copy.objects.filter(corrector=user)

        else:
            # Student voit ses copies publiÃ©es
            return Copy.objects.filter(
                student__user=user,
                status=Copy.Status.PUBLISHED
            )
```

### Frontend (Composant Vue)

```vue
<template>
  <div>
    <!-- Admin uniquement -->
    <button v-if="authStore.isAdmin" @click="deleteExam">
      Supprimer Examen
    </button>

    <!-- Teacher + Admin -->
    <button v-if="authStore.isTeacher || authStore.isAdmin" @click="gradeCopy">
      Corriger
    </button>

    <!-- Tout le monde (authentifiÃ©) -->
    <button v-if="authStore.isAuthenticated" @click="viewResults">
      Voir RÃ©sultats
    </button>
  </div>
</template>

<script setup lang="ts">
import { useAuthStore } from '@/stores/auth'

const authStore = useAuthStore()
</script>
```

---

## ğŸ“‹ CrÃ©ation de Comptes

### Via Django Admin

1. **AccÃ©der** : http://localhost:8088/admin/
2. **Login** : test_admin / admin123
3. **Naviguer** : Users â†’ Add User
4. **Remplir** :
   - Username
   - Password (2Ã— pour confirmation)
   - Email
   - **is_staff** : Cocher si enseignant
   - **is_superuser** : Cocher si admin
   - **Groups** : SÃ©lectionner `teacher` si enseignant

### Via Django Shell

```bash
docker compose exec backend python manage.py shell
```

```python
from django.contrib.auth import get_user_model
from django.contrib.auth.models import Group

User = get_user_model()

# CrÃ©er Admin
admin = User.objects.create_superuser(
    username='admin_new',
    email='admin@korrigo.tn',
    password='secure_admin_password'
)

# CrÃ©er Enseignant
teacher = User.objects.create_user(
    username='prof_new',
    email='prof@korrigo.tn',
    password='secure_teacher_password',
    first_name='Jean',
    last_name='Dupont',
    is_staff=True  # IMPORTANT
)
teacher_group = Group.objects.get(name='teacher')
teacher.groups.add(teacher_group)

# CrÃ©er Ã‰tudiant (avec Student record)
from students.models import Student
from datetime import date

student_user = User.objects.create_user(
    username='eleve_new',
    email='eleve.new@korrigo.local',
    password='secure_student_password',
    first_name='Marie',
    last_name='Martin',
    is_staff=False
)

student_record = Student.objects.create(
    user=student_user,
    first_name='Marie',
    last_name='Martin',
    email='eleve.new@korrigo.local',
    date_of_birth=date(2008, 3, 15),
    class_name='G3'
)
```

### Via Script de Seed

**Fichier** : `backend/seed_users.py`

```python
from django.contrib.auth import get_user_model
from django.contrib.auth.models import Group
from students.models import Student
from datetime import date

User = get_user_model()

# Admins
admins = [
    {'username': 'admin1', 'email': 'admin1@korrigo.tn', 'password': 'admin123'},
]

for admin_data in admins:
    User.objects.create_superuser(**admin_data)

# Teachers
teacher_group = Group.objects.get(name='teacher')

teachers = [
    {'username': 'prof1', 'email': 'prof1@korrigo.tn', 'password': 'prof123'},
    {'username': 'prof2', 'email': 'prof2@korrigo.tn', 'password': 'prof123'},
]

for teacher_data in teachers:
    teacher = User.objects.create_user(**teacher_data, is_staff=True)
    teacher.groups.add(teacher_group)

# Students
students_data = [
    {'username': 'eleve1', 'email': 'eleve1@korrigo.local', 'first_name': 'Jean', 'last_name': 'Dupont', 'dob': date(2008, 5, 15)},
    {'username': 'eleve2', 'email': 'eleve2@korrigo.local', 'first_name': 'Marie', 'last_name': 'Martin', 'dob': date(2007, 12, 3)},
]

for student_data in students_data:
    user = User.objects.create_user(
        username=student_data['username'],
        email=student_data['email'],
        password='eleve2025',
        first_name=student_data['first_name'],
        last_name=student_data['last_name'],
        is_staff=False
    )

    Student.objects.create(
        user=user,
        first_name=student_data['first_name'],
        last_name=student_data['last_name'],
        email=student_data['email'],
        date_of_birth=student_data['dob'],
        class_name='G3'
    )

print("Users seeded successfully")
```

---

## ğŸ“ Conclusion

Le systÃ¨me de profils et permissions de Korrigo offre une sÃ©paration claire des responsabilitÃ©s et une sÃ©curitÃ© renforcÃ©e.

**Points clÃ©s** :
- 3 profils distincts (Admin, Teacher, Student)
- Permissions granulaires par action
- VÃ©rifications backend + frontend
- Groupes Django pour gestion simplifiÃ©e
- Matrice de permissions complÃ¨te

---

**Document rÃ©digÃ© par :**
**Alaeddine BEN RHOUMA**
*Lead Senior Documentation & Architecture*
Date : 3 FÃ©vrier 2026
