# 03.5 - API √âtudiants (Portail √âl√®ve)

**Projet** : Korrigo - Syst√®me de Correction d'Examens
**Version** : 2.0 (PRD-19)
**Date** : 3 F√©vrier 2026
**Auteur** : **Alaeddine BEN RHOUMA**

---

## üéØ Objectif

L'API √âtudiants permet aux √©l√®ves de :
- Se connecter avec email + date de naissance
- Consulter leurs copies corrig√©es
- T√©l√©charger leurs r√©sultats PDF
- Visualiser leurs statistiques

---

## üîë Authentification √âl√®ve

### Sp√©cificit√©

Les √©tudiants utilisent un **syst√®me d'authentification alternatif** sans compte utilisateur Django :
- **Login** : Email + Date de naissance (pas de mot de passe)
- **Session** : Cookie Django avec `student_id`
- **Permissions** : Acc√®s limit√© √† leurs propres copies

---

## üìã Endpoints

### 1. Login √âtudiant

**POST** `/api/students/login/`

Authentifie un √©tudiant avec email + date de naissance.

#### Permissions
- **Public** (AllowAny)

#### Request Body

```json
{
  "email": "jean.dupont@viatique.local",
  "date_of_birth": "15/05/2008"
}
```

#### Response (200 OK)

```json
{
  "success": true,
  "student": {
    "id": 42,
    "first_name": "Jean",
    "last_name": "DUPONT",
    "email": "jean.dupont@viatique.local",
    "student_number": "STU001",
    "class_name": "G3"
  },
  "session_expires_at": "2026-02-03T18:30:00Z"
}
```

#### Errors

| Code | Raison |
|------|--------|
| 400 | Champs manquants |
| 401 | Email ou date de naissance incorrects |
| 404 | √âtudiant non trouv√© |

#### Exemple cURL

```bash
curl -X POST http://localhost:8088/api/students/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "email": "jean.dupont@viatique.local",
    "date_of_birth": "15/05/2008"
  }' \
  -c cookies.txt
```

#### Exemple Axios

```javascript
const response = await axios.post('/api/students/login/', {
  email: 'jean.dupont@viatique.local',
  date_of_birth: '15/05/2008'
}, { withCredentials: true })

// Session cookie automatiquement stock√©
```

---

### 2. R√©cup√©rer Profil √âtudiant

**GET** `/api/students/me/`

R√©cup√®re les informations du profil de l'√©tudiant connect√©.

#### Permissions
- **IsStudent** (session cookie requis)

#### Response (200 OK)

```json
{
  "id": 42,
  "first_name": "Jean",
  "last_name": "DUPONT",
  "email": "jean.dupont@viatique.local",
  "date_of_birth": "2008-05-15",
  "student_number": "STU001",
  "class_name": "G3",
  "created_at": "2026-01-15T10:00:00Z"
}
```

#### Errors

| Code | Raison |
|------|--------|
| 401 | Session expir√©e ou invalide |

#### Exemple cURL

```bash
curl http://localhost:8088/api/students/me/ \
  -b cookies.txt
```

---

### 3. Lister Copies √âl√®ve

**GET** `/api/students/copies/`

Liste toutes les copies de l'√©tudiant connect√© (publi√©es uniquement).

#### Permissions
- **IsStudent**

#### Query Parameters

| Param√®tre | Type | Description | D√©faut |
|-----------|------|-------------|--------|
| `exam_id` | int | Filtrer par examen | - |
| `status` | string | Filtrer par statut (GRADED, PUBLISHED) | - |

#### Response (200 OK)

```json
{
  "count": 3,
  "results": [
    {
      "id": 156,
      "anonymous_id": "A001",
      "exam": {
        "id": 5,
        "title": "√âvaluation Loi Binomiale",
        "subject": "Math√©matiques",
        "date": "2026-01-20"
      },
      "status": "PUBLISHED",
      "total_score": 15.5,
      "max_score": 20.0,
      "percentage": 77.5,
      "published_at": "2026-01-25T14:00:00Z",
      "pdf_url": "/api/students/copies/156/pdf/",
      "teacher_comment": "Bon travail, attention aux calculs."
    },
    {
      "id": 142,
      "anonymous_id": "A007",
      "exam": {
        "id": 4,
        "title": "Contr√¥le Probabilit√©s",
        "subject": "Math√©matiques",
        "date": "2026-01-10"
      },
      "status": "PUBLISHED",
      "total_score": 18.0,
      "max_score": 20.0,
      "percentage": 90.0,
      "published_at": "2026-01-15T10:30:00Z",
      "pdf_url": "/api/students/copies/142/pdf/"
    }
  ]
}
```

#### Exemple cURL

```bash
# Toutes les copies
curl http://localhost:8088/api/students/copies/ \
  -b cookies.txt

# Copies d'un examen sp√©cifique
curl "http://localhost:8088/api/students/copies/?exam_id=5" \
  -b cookies.txt
```

#### Exemple Axios

```javascript
const response = await axios.get('/api/students/copies/', {
  params: { exam_id: 5 },
  withCredentials: true
})

const copies = response.data.results
```

---

### 4. R√©cup√©rer D√©tails Copie

**GET** `/api/students/copies/{id}/`

R√©cup√®re les d√©tails d'une copie avec notes par question.

#### Permissions
- **IsStudent** (copie appartient √† l'√©tudiant)
- **Status** : PUBLISHED uniquement

#### Response (200 OK)

```json
{
  "id": 156,
  "anonymous_id": "A001",
  "exam": {
    "id": 5,
    "title": "√âvaluation Loi Binomiale",
    "subject": "Math√©matiques",
    "date": "2026-01-20",
    "total_points": 20.0
  },
  "student": {
    "first_name": "Jean",
    "last_name": "DUPONT"
  },
  "status": "PUBLISHED",
  "total_score": 15.5,
  "max_score": 20.0,
  "percentage": 77.5,
  "published_at": "2026-01-25T14:00:00Z",
  "graded_by": {
    "first_name": "Marie",
    "last_name": "Dubois"
  },
  "grades": [
    {
      "question_number": 1,
      "question_title": "Calcul de probabilit√©",
      "score": 4.0,
      "max_score": 5.0,
      "comment": "Bien mais oubli de la conclusion"
    },
    {
      "question_number": 2,
      "question_title": "Loi binomiale",
      "score": 5.0,
      "max_score": 5.0,
      "comment": "Parfait"
    },
    {
      "question_number": 3,
      "question_title": "Exercice synth√®se",
      "score": 6.5,
      "max_score": 10.0,
      "comment": "Erreur de calcul ligne 3"
    }
  ],
  "teacher_comment": "Bon travail, attention aux calculs.",
  "pdf_url": "/api/students/copies/156/pdf/"
}
```

#### Errors

| Code | Raison |
|------|--------|
| 403 | Copie non publi√©e ou n'appartient pas √† l'√©tudiant |
| 404 | Copie introuvable |

#### Exemple cURL

```bash
curl http://localhost:8088/api/students/copies/156/ \
  -b cookies.txt
```

---

### 5. T√©l√©charger PDF Copie

**GET** `/api/students/copies/{id}/pdf/`

T√©l√©charge le PDF de la copie corrig√©e.

#### Permissions
- **IsStudent** (copie publi√©e uniquement)

#### Response (200 OK)

- **Content-Type** : `application/pdf`
- **Content-Disposition** : `attachment; filename="copie_A001_DUPONT_Jean.pdf"`

#### Errors

| Code | Raison |
|------|--------|
| 403 | Copie non publi√©e |
| 404 | PDF introuvable |

#### Exemple cURL

```bash
curl http://localhost:8088/api/students/copies/156/pdf/ \
  -b cookies.txt \
  -o copie_A001.pdf
```

#### Exemple Frontend

```javascript
// T√©l√©chargement dans le navigateur
function downloadPDF(copyId) {
  const url = `/api/students/copies/${copyId}/pdf/`

  // Axios avec responseType blob
  axios.get(url, {
    responseType: 'blob',
    withCredentials: true
  }).then(response => {
    // Cr√©er lien de t√©l√©chargement
    const blob = new Blob([response.data], { type: 'application/pdf' })
    const link = document.createElement('a')
    link.href = window.URL.createObjectURL(blob)
    link.download = `copie_${copyId}.pdf`
    link.click()
  })
}
```

---

### 6. Statistiques √âl√®ve

**GET** `/api/students/statistics/`

R√©cup√®re les statistiques globales de l'√©tudiant.

#### Permissions
- **IsStudent**

#### Response (200 OK)

```json
{
  "student": {
    "first_name": "Jean",
    "last_name": "DUPONT"
  },
  "overall": {
    "total_exams": 5,
    "published_exams": 3,
    "pending_exams": 2,
    "average_score": 16.8,
    "average_percentage": 84.0
  },
  "by_subject": [
    {
      "subject": "Math√©matiques",
      "exam_count": 3,
      "average_score": 16.3,
      "average_percentage": 81.5,
      "best_score": 18.0,
      "worst_score": 15.5
    },
    {
      "subject": "Physique",
      "exam_count": 2,
      "average_score": 17.5,
      "average_percentage": 87.5,
      "best_score": 18.5,
      "worst_score": 16.5
    }
  ],
  "recent_exams": [
    {
      "exam_title": "√âvaluation Loi Binomiale",
      "date": "2026-01-20",
      "score": 15.5,
      "percentage": 77.5,
      "class_average": 14.2
    }
  ]
}
```

#### Exemple cURL

```bash
curl http://localhost:8088/api/students/statistics/ \
  -b cookies.txt
```

---

### 7. Logout √âtudiant

**POST** `/api/students/logout/`

D√©connecte l'√©tudiant (supprime session).

#### Permissions
- **IsStudent**

#### Response (200 OK)

```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

#### Exemple cURL

```bash
curl -X POST http://localhost:8088/api/students/logout/ \
  -b cookies.txt
```

---

## üíª Impl√©mentation Backend

### Vue StudentAuthView

**Fichier** : `backend/students/views.py`

```python
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import AllowAny, IsAuthenticated
from rest_framework.response import Response
from rest_framework import status
from django.contrib.sessions.models import Session
from django.utils import timezone
from datetime import datetime
from .models import Student
from .serializers import StudentSerializer

@api_view(['POST'])
@permission_classes([AllowAny])
def student_login(request):
    """
    Login √©tudiant avec email + date de naissance.

    Pas de compte utilisateur Django, authentification via session.
    """
    email = request.data.get('email')
    date_of_birth = request.data.get('date_of_birth')

    if not email or not date_of_birth:
        return Response(
            {'error': 'Email and date_of_birth required'},
            status=status.HTTP_400_BAD_REQUEST
        )

    # Parser date (DD/MM/YYYY ou YYYY-MM-DD)
    try:
        if '/' in date_of_birth:
            dob = datetime.strptime(date_of_birth, '%d/%m/%Y').date()
        else:
            dob = datetime.strptime(date_of_birth, '%Y-%m-%d').date()
    except ValueError:
        return Response(
            {'error': 'Invalid date format. Use DD/MM/YYYY or YYYY-MM-DD'},
            status=status.HTTP_400_BAD_REQUEST
        )

    # Chercher √©tudiant
    try:
        student = Student.objects.get(email__iexact=email, date_of_birth=dob)
    except Student.DoesNotExist:
        return Response(
            {'error': 'Invalid credentials'},
            status=status.HTTP_401_UNAUTHORIZED
        )

    # Cr√©er session
    request.session['student_id'] = student.id
    request.session['is_student'] = True
    request.session.set_expiry(3600 * 2)  # 2 heures

    return Response({
        'success': True,
        'student': StudentSerializer(student).data,
        'session_expires_at': timezone.now() + timezone.timedelta(hours=2)
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def student_profile(request):
    """R√©cup√©rer profil √©tudiant connect√©."""
    student_id = request.session.get('student_id')

    if not student_id:
        return Response(
            {'error': 'Not authenticated as student'},
            status=status.HTTP_401_UNAUTHORIZED
        )

    student = Student.objects.get(id=student_id)
    return Response(StudentSerializer(student).data)


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def student_logout(request):
    """Logout √©tudiant."""
    if request.session.get('is_student'):
        request.session.flush()

    return Response({'success': True, 'message': 'Logged out successfully'})
```

### Vue StudentCopyViewSet

**Fichier** : `backend/students/views.py`

```python
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.http import FileResponse
from django.shortcuts import get_object_or_404
from django.db.models import Avg, Count
from copies.models import Copy
from .models import Student
from .serializers import StudentCopySerializer

class StudentCopyViewSet(viewsets.ReadOnlyModelViewSet):
    """
    ViewSet pour consultation copies par √©tudiants.

    Permissions:
    - Lecture seule
    - Copies publi√©es uniquement
    - Uniquement copies de l'√©tudiant connect√©
    """
    serializer_class = StudentCopySerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        """Filtrer copies de l'√©tudiant connect√©."""
        student_id = self.request.session.get('student_id')

        if not student_id:
            return Copy.objects.none()

        # Uniquement copies publi√©es
        queryset = Copy.objects.filter(
            student_id=student_id,
            status='PUBLISHED'
        ).select_related('exam', 'student').prefetch_related('grades')

        # Filtres optionnels
        exam_id = self.request.query_params.get('exam_id')
        if exam_id:
            queryset = queryset.filter(exam_id=exam_id)

        return queryset.order_by('-exam__date', '-published_at')

    def retrieve(self, request, pk=None):
        """R√©cup√©rer d√©tails copie avec notes."""
        copy = self.get_object()

        # V√©rifier que copie appartient √† l'√©tudiant
        student_id = request.session.get('student_id')
        if copy.student_id != student_id:
            return Response(
                {'error': 'Access denied'},
                status=status.HTTP_403_FORBIDDEN
            )

        serializer = self.get_serializer(copy)
        return Response(serializer.data)

    @action(detail=True, methods=['get'])
    def pdf(self, request, pk=None):
        """T√©l√©charger PDF copie corrig√©e."""
        copy = self.get_object()

        # V√©rifier ownership
        student_id = request.session.get('student_id')
        if copy.student_id != student_id:
            return Response(
                {'error': 'Access denied'},
                status=status.HTTP_403_FORBIDDEN
            )

        # V√©rifier que PDF existe
        if not copy.pdf_file:
            return Response(
                {'error': 'PDF not found'},
                status=status.HTTP_404_NOT_FOUND
            )

        # Retourner fichier
        filename = f"copie_{copy.anonymous_id}_{copy.student.last_name}_{copy.student.first_name}.pdf"

        return FileResponse(
            copy.pdf_file.open('rb'),
            as_attachment=True,
            filename=filename,
            content_type='application/pdf'
        )

    @action(detail=False, methods=['get'])
    def statistics(self, request):
        """Statistiques globales √©tudiant."""
        student_id = request.session.get('student_id')
        student = get_object_or_404(Student, id=student_id)

        # Copies publi√©es
        published_copies = Copy.objects.filter(
            student=student,
            status='PUBLISHED'
        ).select_related('exam')

        # Statistiques globales
        overall_stats = published_copies.aggregate(
            total_exams=Count('id'),
            average_score=Avg('total_score')
        )

        # Calcul pourcentage moyen
        if published_copies.exists():
            avg_percentage = sum(
                (c.total_score / c.max_score * 100) for c in published_copies
            ) / published_copies.count()
        else:
            avg_percentage = 0.0

        # Stats par mati√®re
        by_subject = {}
        for copy in published_copies:
            subject = copy.exam.subject
            if subject not in by_subject:
                by_subject[subject] = {
                    'exam_count': 0,
                    'total_score': 0.0,
                    'scores': []
                }

            by_subject[subject]['exam_count'] += 1
            by_subject[subject]['total_score'] += copy.total_score
            by_subject[subject]['scores'].append(copy.total_score)

        subject_stats = []
        for subject, data in by_subject.items():
            subject_stats.append({
                'subject': subject,
                'exam_count': data['exam_count'],
                'average_score': data['total_score'] / data['exam_count'],
                'average_percentage': (data['total_score'] / data['exam_count']) / 20 * 100,
                'best_score': max(data['scores']),
                'worst_score': min(data['scores'])
            })

        # Examens r√©cents
        recent_exams = []
        for copy in published_copies.order_by('-exam__date')[:5]:
            recent_exams.append({
                'exam_title': copy.exam.title,
                'date': copy.exam.date,
                'score': copy.total_score,
                'percentage': (copy.total_score / copy.max_score * 100),
                'class_average': copy.exam.copies.filter(
                    status='PUBLISHED'
                ).aggregate(Avg('total_score'))['total_score__avg'] or 0.0
            })

        return Response({
            'student': {
                'first_name': student.first_name,
                'last_name': student.last_name
            },
            'overall': {
                'total_exams': Copy.objects.filter(student=student).count(),
                'published_exams': overall_stats['total_exams'],
                'pending_exams': Copy.objects.filter(
                    student=student,
                    status__in=['UPLOADED', 'GRADING']
                ).count(),
                'average_score': overall_stats['average_score'] or 0.0,
                'average_percentage': avg_percentage
            },
            'by_subject': subject_stats,
            'recent_exams': recent_exams
        })
```

### Middleware IsStudent

**Fichier** : `backend/core/permissions.py`

```python
from rest_framework.permissions import BasePermission

class IsStudent(BasePermission):
    """Permission pour v√©rifier session √©tudiant."""

    def has_permission(self, request, view):
        """V√©rifier que user est √©tudiant (session)."""
        return bool(
            request.session and
            request.session.get('is_student') and
            request.session.get('student_id')
        )
```

### Serializers

**Fichier** : `backend/students/serializers.py`

```python
from rest_framework import serializers
from .models import Student
from copies.models import Copy
from grading.models import Grade

class StudentSerializer(serializers.ModelSerializer):
    """Serializer pour profil √©tudiant."""

    class Meta:
        model = Student
        fields = [
            'id', 'first_name', 'last_name', 'email',
            'date_of_birth', 'student_number', 'class_name',
            'created_at'
        ]
        read_only_fields = ['id', 'created_at']


class StudentCopyGradeSerializer(serializers.ModelSerializer):
    """Serializer pour notes visibles par √©tudiant."""

    question_number = serializers.IntegerField(source='question.question_number')
    question_title = serializers.CharField(source='question.title')

    class Meta:
        model = Grade
        fields = [
            'question_number', 'question_title',
            'score', 'max_score', 'comment'
        ]


class StudentCopySerializer(serializers.ModelSerializer):
    """Serializer pour copies visibles par √©tudiant."""

    exam = serializers.SerializerMethodField()
    grades = StudentCopyGradeSerializer(many=True, read_only=True)
    percentage = serializers.SerializerMethodField()
    pdf_url = serializers.SerializerMethodField()
    graded_by = serializers.SerializerMethodField()

    class Meta:
        model = Copy
        fields = [
            'id', 'anonymous_id', 'exam', 'status',
            'total_score', 'max_score', 'percentage',
            'grades', 'teacher_comment',
            'published_at', 'graded_by', 'pdf_url'
        ]

    def get_exam(self, obj):
        return {
            'id': obj.exam.id,
            'title': obj.exam.title,
            'subject': obj.exam.subject,
            'date': obj.exam.date,
            'total_points': obj.exam.total_points
        }

    def get_percentage(self, obj):
        if obj.max_score and obj.max_score > 0:
            return round((obj.total_score / obj.max_score) * 100, 1)
        return 0.0

    def get_pdf_url(self, obj):
        return f"/api/students/copies/{obj.id}/pdf/"

    def get_graded_by(self, obj):
        if obj.graded_by:
            return {
                'first_name': obj.graded_by.first_name,
                'last_name': obj.graded_by.last_name
            }
        return None
```

---

## üåê Impl√©mentation Frontend

### Service API √âtudiant

**Fichier** : `frontend/src/services/studentApi.ts`

```typescript
import axios from 'axios'

const API_BASE = '/api/students'

export interface StudentLoginPayload {
  email: string
  date_of_birth: string // DD/MM/YYYY
}

export interface StudentProfile {
  id: number
  first_name: string
  last_name: string
  email: string
  date_of_birth: string
  student_number: string
  class_name: string
}

export interface StudentCopy {
  id: number
  anonymous_id: string
  exam: {
    id: number
    title: string
    subject: string
    date: string
  }
  status: string
  total_score: number
  max_score: number
  percentage: number
  published_at: string
  pdf_url: string
}

export const studentApi = {
  // Login
  async login(payload: StudentLoginPayload) {
    const response = await axios.post(`${API_BASE}/login/`, payload, {
      withCredentials: true
    })
    return response.data
  },

  // Profil
  async getProfile(): Promise<StudentProfile> {
    const response = await axios.get(`${API_BASE}/me/`, {
      withCredentials: true
    })
    return response.data
  },

  // Copies
  async getCopies(examId?: number): Promise<StudentCopy[]> {
    const response = await axios.get(`${API_BASE}/copies/`, {
      params: { exam_id: examId },
      withCredentials: true
    })
    return response.data.results
  },

  async getCopyDetail(copyId: number) {
    const response = await axios.get(`${API_BASE}/copies/${copyId}/`, {
      withCredentials: true
    })
    return response.data
  },

  async downloadPDF(copyId: number, filename: string) {
    const response = await axios.get(`${API_BASE}/copies/${copyId}/pdf/`, {
      responseType: 'blob',
      withCredentials: true
    })

    // T√©l√©chargement navigateur
    const blob = new Blob([response.data], { type: 'application/pdf' })
    const link = document.createElement('a')
    link.href = window.URL.createObjectURL(blob)
    link.download = filename
    link.click()
  },

  // Statistiques
  async getStatistics() {
    const response = await axios.get(`${API_BASE}/statistics/`, {
      withCredentials: true
    })
    return response.data
  },

  // Logout
  async logout() {
    const response = await axios.post(`${API_BASE}/logout/`, {}, {
      withCredentials: true
    })
    return response.data
  }
}
```

### Composant Login √âtudiant

**Fichier** : `frontend/src/views/StudentLogin.vue`

```vue
<template>
  <div class="student-login">
    <h1>üéì Portail √âl√®ve - Korrigo</h1>

    <form @submit.prevent="handleLogin">
      <div class="form-group">
        <label>üìß Email</label>
        <input
          v-model="email"
          type="email"
          placeholder="jean.dupont@viatique.local"
          required
        />
      </div>

      <div class="form-group">
        <label>üéÇ Date de Naissance (JJ/MM/AAAA)</label>
        <input
          v-model="dateOfBirth"
          type="text"
          placeholder="15/05/2008"
          pattern="\d{2}/\d{2}/\d{4}"
          required
        />
      </div>

      <button type="submit" :disabled="loading">
        {{ loading ? 'Connexion...' : 'Se Connecter' }}
      </button>

      <p v-if="error" class="error">{{ error }}</p>
    </form>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { studentApi } from '@/services/studentApi'

const router = useRouter()

const email = ref('')
const dateOfBirth = ref('')
const loading = ref(false)
const error = ref('')

async function handleLogin() {
  loading.value = true
  error.value = ''

  try {
    const response = await studentApi.login({
      email: email.value,
      date_of_birth: dateOfBirth.value
    })

    // Rediriger vers dashboard
    router.push('/student/dashboard')
  } catch (err: any) {
    error.value = err.response?.data?.error || 'Connexion √©chou√©e'
  } finally {
    loading.value = false
  }
}
</script>
```

### Composant Dashboard √âtudiant

**Fichier** : `frontend/src/views/StudentDashboard.vue`

```vue
<template>
  <div class="student-dashboard">
    <header>
      <h1>Bienvenue {{ profile?.first_name }} {{ profile?.last_name }}</h1>
      <button @click="handleLogout">D√©connexion</button>
    </header>

    <section class="stats-overview">
      <div class="stat-card">
        <h3>{{ statistics?.overall.published_exams }}</h3>
        <p>Examens Publi√©s</p>
      </div>
      <div class="stat-card">
        <h3>{{ statistics?.overall.average_percentage.toFixed(1) }}%</h3>
        <p>Moyenne G√©n√©rale</p>
      </div>
      <div class="stat-card">
        <h3>{{ statistics?.overall.pending_exams }}</h3>
        <p>En Attente</p>
      </div>
    </section>

    <section class="copies-list">
      <h2>üìù Mes Copies</h2>

      <div v-for="copy in copies" :key="copy.id" class="copy-card">
        <div class="copy-header">
          <h3>{{ copy.exam.title }}</h3>
          <span class="date">{{ copy.exam.date }}</span>
        </div>

        <div class="copy-score">
          <span class="score">{{ copy.total_score }} / {{ copy.max_score }}</span>
          <span class="percentage" :class="{ good: copy.percentage >= 75 }">
            {{ copy.percentage }}%
          </span>
        </div>

        <div class="copy-actions">
          <button @click="viewCopy(copy.id)">Voir D√©tails</button>
          <button @click="downloadPDF(copy.id, copy.anonymous_id)">
            T√©l√©charger PDF
          </button>
        </div>
      </div>
    </section>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { studentApi } from '@/services/studentApi'

const router = useRouter()

const profile = ref(null)
const statistics = ref(null)
const copies = ref([])

onMounted(async () => {
  await loadData()
})

async function loadData() {
  profile.value = await studentApi.getProfile()
  statistics.value = await studentApi.getStatistics()
  copies.value = await studentApi.getCopies()
}

function viewCopy(copyId: number) {
  router.push(`/student/copies/${copyId}`)
}

async function downloadPDF(copyId: number, anonymousId: string) {
  await studentApi.downloadPDF(copyId, `copie_${anonymousId}.pdf`)
}

async function handleLogout() {
  await studentApi.logout()
  router.push('/student/login')
}
</script>
```

---

## üîê S√©curit√©

### 1. Authentification Sans Mot de Passe

**Risques** :
- ‚ö†Ô∏è Moins s√©curis√© qu'un mot de passe
- ‚ö†Ô∏è Date de naissance = information publique potentielle

**Mitigations** :
- ‚úÖ Session courte (2 heures)
- ‚úÖ Acc√®s lecture seule (pas de modification)
- ‚úÖ Copies publi√©es uniquement
- ‚úÖ Rate limiting sur endpoint login

### 2. CSRF Protection

```python
# settings.py

CSRF_COOKIE_HTTPONLY = False  # JS doit lire le cookie
CSRF_COOKIE_SECURE = True     # HTTPS uniquement
CSRF_COOKIE_SAMESITE = 'Strict'

SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SECURE = True
SESSION_COOKIE_SAMESITE = 'Strict'
```

### 3. Rate Limiting

```python
# views.py (avec django-ratelimit)

from django_ratelimit.decorators import ratelimit

@ratelimit(key='ip', rate='5/m', method='POST')
@api_view(['POST'])
def student_login(request):
    """Login limit√© √† 5 tentatives par minute."""
    # ...
```

---

## ‚úÖ Tests

### Test Login

**Fichier** : `backend/students/tests/test_auth.py`

```python
from django.test import TestCase
from django.urls import reverse
from rest_framework.test import APIClient
from students.models import Student
from datetime import date

class StudentAuthTestCase(TestCase):
    def setUp(self):
        self.client = APIClient()

        # Cr√©er √©tudiant test
        self.student = Student.objects.create(
            first_name='Jean',
            last_name='DUPONT',
            email='jean.dupont@viatique.local',
            date_of_birth=date(2008, 5, 15),
            student_number='STU001'
        )

    def test_login_success(self):
        """Test login valide."""
        response = self.client.post(reverse('student-login'), {
            'email': 'jean.dupont@viatique.local',
            'date_of_birth': '15/05/2008'
        })

        self.assertEqual(response.status_code, 200)
        self.assertTrue(response.data['success'])
        self.assertEqual(response.data['student']['id'], self.student.id)

        # V√©rifier session
        session = self.client.session
        self.assertEqual(session['student_id'], self.student.id)
        self.assertTrue(session['is_student'])

    def test_login_invalid_credentials(self):
        """Test login avec mauvaises credentials."""
        response = self.client.post(reverse('student-login'), {
            'email': 'jean.dupont@viatique.local',
            'date_of_birth': '01/01/2000'  # Mauvaise date
        })

        self.assertEqual(response.status_code, 401)

    def test_access_profile_after_login(self):
        """Test acc√®s profil apr√®s login."""
        # Login
        self.client.post(reverse('student-login'), {
            'email': 'jean.dupont@viatique.local',
            'date_of_birth': '15/05/2008'
        })

        # R√©cup√©rer profil
        response = self.client.get(reverse('student-profile'))

        self.assertEqual(response.status_code, 200)
        self.assertEqual(response.data['email'], 'jean.dupont@viatique.local')
```

---

## üìù Conclusion

L'API √âtudiants offre un portail simple et s√©curis√© pour consulter les r√©sultats. L'authentification email + date de naissance √©vite la gestion de mots de passe tout en restant suffisamment s√©curis√©e pour un contexte √©ducatif.

**Points cl√©s** :
- Authentification alternative sans compte utilisateur
- Acc√®s lecture seule aux copies publi√©es
- T√©l√©chargement PDF s√©curis√©
- Statistiques globales et par mati√®re
- Session courte (2h) avec CSRF protection

---

**Document r√©dig√© par :**
**Alaeddine BEN RHOUMA**
*Lead Senior Documentation & Architecture*
Date : 3 F√©vrier 2026
