# 03.1 - API Authentification et Sessions

**Projet** : Korrigo - Syst√®me de Correction d'Examens
**Version** : 2.0 (PRD-19)
**Date** : 3 F√©vrier 2026
**Auteur** : **Alaeddine BEN RHOUMA**

---

## üéØ Vue d'Ensemble

L'authentification Korrigo repose sur un syst√®me de **sessions Django** avec protection **CSRF**. Les utilisateurs s'authentifient une fois et re√ßoivent un **cookie de session** valable 24 heures.

### M√©thode d'Authentification

- **Backend** : Django Session Authentication
- **Frontend** : Axios avec `withCredentials: true` (cookies automatiques)
- **Protection** : CSRF Token + CORS configur√©
- **Dur√©e session** : 24 heures (configurable)

---

## üîê Endpoints d'Authentification

### 1. POST /api/login/

**Description** : Authentifier un utilisateur (admin, enseignant, √©tudiant)

**URL** : `http://localhost:8088/api/login/`

**M√©thode** : POST

**Headers** :
```
Content-Type: application/json
```

**Body** :
```json
{
  "username": "test_admin",
  "password": "admin123"
}
```

**R√©ponse Success (200 OK)** :
```json
{
  "success": true,
  "user": {
    "id": 1,
    "username": "test_admin",
    "email": "admin@korrigo.tn",
    "first_name": "Admin",
    "last_name": "Korrigo",
    "is_staff": true,
    "is_superuser": true,
    "groups": ["admin", "teacher"],
    "role": "Admin"
  }
}
```

**R√©ponse Error (403 Forbidden)** :
```json
{
  "error": "Invalid credentials"
}
```

**Cookies Retourn√©s** :
- `sessionid` : ID de session Django (HttpOnly)
- `csrftoken` : Token CSRF pour requ√™tes suivantes

**Code Backend** :

```python
# backend/core/views.py

from django.contrib.auth import authenticate, login
from rest_framework.decorators import api_view
from rest_framework.response import Response

@api_view(['POST'])
def login_view(request):
    """
    Authentification utilisateur.

    Body:
        {
            "username": "test_admin",
            "password": "admin123"
        }

    Returns:
        {
            "success": true,
            "user": {...}
        }
    """
    username = request.data.get('username')
    password = request.data.get('password')

    if not username or not password:
        return Response({
            'error': 'Username and password required'
        }, status=400)

    # Authentifier
    user = authenticate(request, username=username, password=password)

    if user is not None and user.is_active:
        # Cr√©er session
        login(request, user)

        # D√©terminer r√¥le
        if user.is_superuser:
            role = "Admin"
        elif user.groups.filter(name='teacher').exists() or user.is_staff:
            role = "Teacher"
        else:
            role = "Student"

        return Response({
            'success': True,
            'user': {
                'id': user.id,
                'username': user.username,
                'email': user.email,
                'first_name': user.first_name,
                'last_name': user.last_name,
                'is_staff': user.is_staff,
                'is_superuser': user.is_superuser,
                'groups': [g.name for g in user.groups.all()],
                'role': role
            }
        }, status=200)

    return Response({
        'error': 'Invalid credentials'
    }, status=403)
```

**Exemple cURL** :

```bash
curl -X POST http://localhost:8088/api/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"test_admin","password":"admin123"}' \
  -c cookies.txt  # Sauvegarder cookies
```

**Exemple Axios (Frontend)** :

```typescript
// frontend/src/services/api.ts

import axios from 'axios'

const api = axios.create({
  baseURL: 'http://localhost:8088',
  withCredentials: true,  // IMPORTANT: Envoyer cookies automatiquement
})

// Login
async function login(username: string, password: string) {
  const response = await api.post('/api/login/', {
    username,
    password
  })

  if (response.data.success) {
    // Cookies sessionid et csrftoken sont automatiquement sauvegard√©s
    return response.data.user
  }

  throw new Error(response.data.error)
}
```

---

### 2. POST /api/logout/

**Description** : D√©connecter l'utilisateur (invalider session)

**URL** : `http://localhost:8088/api/logout/`

**M√©thode** : POST

**Headers** :
```
Cookie: sessionid=abc123...
X-CSRFToken: xyz789...
```

**R√©ponse Success (200 OK)** :
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

**Code Backend** :

```python
from django.contrib.auth import logout
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def logout_view(request):
    """
    D√©connexion utilisateur.

    Returns:
        {"success": true}
    """
    logout(request)

    return Response({
        'success': True,
        'message': 'Logged out successfully'
    })
```

**Exemple cURL** :

```bash
curl -X POST http://localhost:8088/api/logout/ \
  -b cookies.txt \
  -H "X-CSRFToken: $(grep csrftoken cookies.txt | cut -f7)"
```

**Exemple Axios** :

```typescript
async function logout() {
  await api.post('/api/logout/')
  // Session invalid√©e, cookies supprim√©s par navigateur
}
```

---

### 3. GET /api/me/

**Description** : R√©cup√©rer les informations de l'utilisateur connect√©

**URL** : `http://localhost:8088/api/me/`

**M√©thode** : GET

**Headers** :
```
Cookie: sessionid=abc123...
```

**R√©ponse Success (200 OK)** :
```json
{
  "id": 1,
  "username": "test_admin",
  "email": "admin@korrigo.tn",
  "first_name": "Admin",
  "last_name": "Korrigo",
  "role": "Admin",
  "is_staff": true,
  "is_superuser": true,
  "groups": ["admin", "teacher"],
  "permissions": [
    "create_exam",
    "assign_corrector",
    "view_all_copies",
    "manage_users"
  ]
}
```

**R√©ponse Error (401 Unauthorized)** :
```json
{
  "detail": "Authentication credentials were not provided."
}
```

**Code Backend** :

```python
@api_view(['GET'])
@permission_classes([IsAuthenticated])
def me_view(request):
    """
    R√©cup√©rer informations utilisateur connect√©.

    Returns:
        {
            "id": 1,
            "username": "test_admin",
            "role": "Admin",
            "permissions": [...]
        }
    """
    user = request.user

    # D√©terminer r√¥le
    if user.is_superuser:
        role = "Admin"
    elif user.groups.filter(name='teacher').exists() or user.is_staff:
        role = "Teacher"
    else:
        role = "Student"

    # Permissions
    permissions = []
    if user.is_superuser:
        permissions = ['create_exam', 'assign_corrector', 'view_all_copies', 'manage_users', 'finalize_exam']
    elif user.is_staff:
        permissions = ['view_assigned_copies', 'grade_copies', 'annotate_copies']
    else:
        permissions = ['view_own_results', 'download_copy']

    return Response({
        'id': user.id,
        'username': user.username,
        'email': user.email,
        'first_name': user.first_name,
        'last_name': user.last_name,
        'role': role,
        'is_staff': user.is_staff,
        'is_superuser': user.is_superuser,
        'groups': [g.name for g in user.groups.all()],
        'permissions': permissions
    })
```

**Exemple cURL** :

```bash
curl -X GET http://localhost:8088/api/me/ \
  -b cookies.txt
```

**Exemple Axios** :

```typescript
async function getMe() {
  const response = await api.get('/api/me/')
  return response.data
}
```

---

## üç™ Gestion des Cookies et CSRF

### Configuration Django

**Fichier** : `backend/config/settings.py`

```python
# Session
SESSION_ENGINE = 'django.contrib.sessions.backends.db'
SESSION_COOKIE_AGE = 86400  # 24 heures
SESSION_SAVE_EVERY_REQUEST = True  # Renouveler √† chaque requ√™te
SESSION_COOKIE_HTTPONLY = True  # Pas accessible en JS (s√©curit√©)
SESSION_COOKIE_SECURE = True  # HTTPS uniquement (production)
SESSION_COOKIE_SAMESITE = 'Lax'  # Protection CSRF

# CSRF
CSRF_COOKIE_HTTPONLY = False  # Accessible en JS (requis pour Axios)
CSRF_COOKIE_SECURE = True  # HTTPS uniquement (production)
CSRF_COOKIE_SAMESITE = 'Lax'
CSRF_TRUSTED_ORIGINS = [
    'http://localhost:8088',
    'https://korrigo.labomths.tn'
]

# CORS
CORS_ALLOWED_ORIGINS = [
    'http://localhost:8088',
    'https://korrigo.labomths.tn'
]
CORS_ALLOW_CREDENTIALS = True  # Autoriser cookies

CORS_ALLOW_HEADERS = [
    'accept',
    'accept-encoding',
    'authorization',
    'content-type',
    'dnt',
    'origin',
    'user-agent',
    'x-csrftoken',  # IMPORTANT pour CSRF
    'x-requested-with',
]
```

### Axios Interceptor (Frontend)

**Fichier** : `frontend/src/services/api.ts`

```typescript
import axios from 'axios'

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8088',
  withCredentials: true,  // Envoyer cookies automatiquement
  headers: {
    'Content-Type': 'application/json'
  }
})

// Intercepteur pour ajouter CSRF token
api.interceptors.request.use((config) => {
  // R√©cup√©rer CSRF token depuis cookie
  const csrfToken = getCookie('csrftoken')

  if (csrfToken) {
    config.headers['X-CSRFToken'] = csrfToken
  }

  return config
}, (error) => {
  return Promise.reject(error)
})

// Intercepteur pour g√©rer erreurs 401
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Rediriger vers login
      window.location.href = '/login'
    }
    return Promise.reject(error)
  }
)

// Helper pour lire cookie
function getCookie(name: string): string | null {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) {
    return parts.pop()?.split(';').shift() || null
  }
  return null
}

export default api
```

---

## üë§ Authentification √âtudiants (Alternative)

### POST /api/students/login/

**Description** : Authentification √©tudiants via email + date de naissance

**URL** : `http://localhost:8088/api/students/login/`

**M√©thode** : POST

**Body** :
```json
{
  "email": "eleve1@korrigo.local",
  "date_of_birth": "2008-05-15"
}
```

**R√©ponse Success (200 OK)** :
```json
{
  "success": true,
  "student": {
    "id": "uuid-student-1",
    "first_name": "Jean",
    "last_name": "Dupont",
    "email": "eleve1@korrigo.local",
    "date_of_birth": "2008-05-15",
    "class_name": "G3"
  }
}
```

**R√©ponse Error (403 Forbidden)** :
```json
{
  "error": "Invalid credentials"
}
```

**Code Backend** :

```python
from students.models import Student

@api_view(['POST'])
def student_login(request):
    """
    Authentification √©tudiant (email + date naissance).

    Body:
        {
            "email": "eleve1@korrigo.local",
            "date_of_birth": "2008-05-15"
        }
    """
    email = request.data.get('email')
    date_of_birth = request.data.get('date_of_birth')

    if not email or not date_of_birth:
        return Response({
            'error': 'Email and date of birth required'
        }, status=400)

    try:
        # Chercher √©tudiant
        student = Student.objects.get(
            email=email,
            date_of_birth=date_of_birth
        )

        # Si User li√©, login Django
        if student.user:
            login(request, student.user)

        return Response({
            'success': True,
            'student': {
                'id': str(student.id),
                'first_name': student.first_name,
                'last_name': student.last_name,
                'email': student.email,
                'date_of_birth': student.date_of_birth,
                'class_name': student.class_name
            }
        })

    except Student.DoesNotExist:
        return Response({
            'error': 'Invalid credentials'
        }, status=403)
```

---

## üîí Permissions et Guards

### Backend Permissions

**Fichier** : `backend/core/permissions.py`

```python
from rest_framework.permissions import BasePermission

class IsAdmin(BasePermission):
    """Permission pour administrateurs uniquement."""

    def has_permission(self, request, view):
        return request.user.is_authenticated and request.user.is_superuser

class IsTeacher(BasePermission):
    """Permission pour enseignants et admins."""

    def has_permission(self, request, view):
        return request.user.is_authenticated and request.user.is_staff

class IsStudent(BasePermission):
    """Permission pour √©tudiants."""

    def has_permission(self, request, view):
        return request.user.is_authenticated and not request.user.is_staff

class IsOwnerOrAdmin(BasePermission):
    """Permission pour propri√©taire de la ressource ou admin."""

    def has_object_permission(self, request, view, obj):
        if request.user.is_superuser:
            return True

        # V√©rifier propri√©taire selon type d'objet
        if hasattr(obj, 'corrector'):
            return obj.corrector == request.user
        if hasattr(obj, 'student'):
            return obj.student.user == request.user

        return False
```

**Usage** :

```python
from rest_framework.decorators import permission_classes
from core.permissions import IsTeacher

@api_view(['GET'])
@permission_classes([IsTeacher])
def teacher_only_view(request):
    """Accessible uniquement aux enseignants et admins."""
    return Response({'message': 'Hello teacher!'})
```

### Frontend Navigation Guards

**Fichier** : `frontend/src/router/index.ts`

```typescript
import { createRouter, createWebHistory } from 'vue-router'
import { useAuthStore } from '@/stores/auth'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/admin/dashboard',
      component: () => import('@/views/admin/DashboardAdmin.vue'),
      meta: {
        requiresAuth: true,
        requiresRole: 'admin'
      }
    },
    {
      path: '/teacher/dashboard',
      component: () => import('@/views/teacher/DashboardTeacher.vue'),
      meta: {
        requiresAuth: true,
        requiresRole: 'teacher'
      }
    },
    {
      path: '/student/portal',
      component: () => import('@/views/student/StudentPortal.vue'),
      meta: {
        requiresAuth: true,
        requiresRole: 'student'
      }
    }
  ]
})

// Navigation Guard
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()

  // Charger utilisateur si pas d√©j√† fait
  if (!authStore.user && to.meta.requiresAuth) {
    try {
      await authStore.fetchMe()
    } catch (error) {
      next('/login')
      return
    }
  }

  // V√©rifier authentification
  if (to.meta.requiresAuth && !authStore.isAuthenticated) {
    next('/login')
    return
  }

  // V√©rifier r√¥le
  if (to.meta.requiresRole) {
    const requiredRole = to.meta.requiresRole as string

    if (requiredRole === 'admin' && !authStore.isAdmin) {
      next('/unauthorized')
      return
    }

    if (requiredRole === 'teacher' && !authStore.isTeacher) {
      next('/unauthorized')
      return
    }

    if (requiredRole === 'student' && !authStore.isStudent) {
      next('/unauthorized')
      return
    }
  }

  next()
})

export default router
```

---

## üß™ Tests d'Authentification

### Test Backend (Pytest)

**Fichier** : `backend/core/tests/test_auth.py`

```python
import pytest
from django.test import Client
from django.contrib.auth import get_user_model

User = get_user_model()

@pytest.mark.django_db
def test_login_success():
    """Test login avec credentials valides."""

    # Setup
    user = User.objects.create_user(
        username='test_user',
        password='test123',
        email='test@test.local'
    )

    client = Client()

    # Execute
    response = client.post('/api/login/', {
        'username': 'test_user',
        'password': 'test123'
    }, content_type='application/json')

    # Assert
    assert response.status_code == 200
    assert response.json()['success'] is True
    assert response.json()['user']['username'] == 'test_user'

    # V√©rifier cookies
    assert 'sessionid' in response.cookies
    assert 'csrftoken' in response.cookies


@pytest.mark.django_db
def test_login_invalid_credentials():
    """Test login avec mauvais mot de passe."""

    client = Client()

    response = client.post('/api/login/', {
        'username': 'test_user',
        'password': 'wrong_password'
    }, content_type='application/json')

    assert response.status_code == 403
    assert 'error' in response.json()


@pytest.mark.django_db
def test_me_authenticated():
    """Test GET /api/me/ avec utilisateur authentifi√©."""

    # Setup
    user = User.objects.create_user(
        username='test_user',
        password='test123',
        is_staff=True
    )

    client = Client()
    client.login(username='test_user', password='test123')

    # Execute
    response = client.get('/api/me/')

    # Assert
    assert response.status_code == 200
    assert response.json()['username'] == 'test_user'
    assert response.json()['role'] == 'Teacher'


@pytest.mark.django_db
def test_me_unauthenticated():
    """Test GET /api/me/ sans authentification."""

    client = Client()

    response = client.get('/api/me/')

    assert response.status_code == 401
```

### Test E2E (Playwright)

**Fichier** : `frontend/tests/e2e/auth_flow.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('Authentication Flow', () => {
  test('Admin login and dashboard', async ({ page }) => {
    // 1. Navigate to login
    await page.goto('http://localhost:8088/login')

    // 2. Fill credentials
    await page.fill('input[name="username"]', 'test_admin')
    await page.fill('input[name="password"]', 'admin123')

    // 3. Submit
    await page.click('button[type="submit"]')

    // 4. Wait for redirect
    await page.waitForURL(/\/admin\/dashboard/)

    // 5. Verify page content
    await expect(page.locator('h1')).toContainText('Tableau de Bord')

    // 6. Verify cookies
    const cookies = await page.context().cookies()
    const sessionCookie = cookies.find(c => c.name === 'sessionid')
    expect(sessionCookie).toBeDefined()
  })

  test('Invalid credentials shows error', async ({ page }) => {
    await page.goto('http://localhost:8088/login')

    await page.fill('input[name="username"]', 'wrong_user')
    await page.fill('input[name="password"]', 'wrong_password')

    await page.click('button[type="submit"]')

    // Expect error message
    await expect(page.locator('.error-message')).toContainText('Invalid credentials')
  })

  test('Logout clears session', async ({ page, context }) => {
    // Login first
    await page.goto('http://localhost:8088/login')
    await page.fill('input[name="username"]', 'test_admin')
    await page.fill('input[name="password"]', 'admin123')
    await page.click('button[type="submit"]')

    await page.waitForURL(/\/admin\/dashboard/)

    // Logout
    await page.click('button[data-testid="logout-button"]')

    // Wait for redirect to login
    await page.waitForURL(/\/login/)

    // Verify session cookie cleared
    const cookies = await context.cookies()
    const sessionCookie = cookies.find(c => c.name === 'sessionid')
    expect(sessionCookie).toBeUndefined()
  })
})
```

---

## üìù Conclusion

L'API d'authentification Korrigo fournit un syst√®me de sessions s√©curis√© avec protection CSRF et gestion des r√¥les.

**Points cl√©s** :
- Sessions Django (24h)
- CSRF protection automatique
- CORS configur√© pour frontend
- Navigation guards (frontend)
- Permissions granulaires (backend)
- Support authentification alternative pour √©tudiants

---

**Document r√©dig√© par :**
**Alaeddine BEN RHOUMA**
*Lead Senior Documentation & Architecture*
Date : 3 F√©vrier 2026
