# 03.6 - Codes d'Erreur API

**Projet** : Korrigo - Syst√®me de Correction d'Examens
**Version** : 2.0 (PRD-19)
**Date** : 3 F√©vrier 2026
**Auteur** : **Alaeddine BEN RHOUMA**

---

## üéØ Objectif

Ce document r√©f√©rence tous les **codes d'erreur HTTP** retourn√©s par l'API Korrigo, leurs significations, et comment les g√©rer c√¥t√© client.

---

## üìã Format Standard des Erreurs

### Structure R√©ponse Erreur

Toutes les r√©ponses d'erreur suivent le format JSON suivant :

```json
{
  "error": "Description courte de l'erreur",
  "details": {
    "field_name": ["Message d'erreur sp√©cifique"],
    "another_field": ["Autre message"]
  },
  "error_code": "UNIQUE_ERROR_CODE",
  "timestamp": "2026-02-03T14:30:00Z"
}
```

### Exemples

**Erreur Simple** :
```json
{
  "error": "Authentication required",
  "error_code": "AUTH_REQUIRED",
  "timestamp": "2026-02-03T14:30:00Z"
}
```

**Erreur de Validation** :
```json
{
  "error": "Validation failed",
  "details": {
    "title": ["This field is required"],
    "total_points": ["Ensure this value is greater than 0"]
  },
  "error_code": "VALIDATION_ERROR",
  "timestamp": "2026-02-03T14:30:00Z"
}
```

---

## üî¢ Codes HTTP Standard

### 2xx - Succ√®s

| Code | Nom | Usage |
|------|-----|-------|
| 200 | OK | Requ√™te r√©ussie (GET, PATCH) |
| 201 | Created | Ressource cr√©√©e (POST) |
| 204 | No Content | Suppression r√©ussie (DELETE) |

---

### 4xx - Erreurs Client

#### 400 - Bad Request

**Description** : Requ√™te malform√©e ou param√®tres invalides.

**Causes Courantes** :
- JSON invalide
- Champs manquants
- Format de donn√©es incorrect
- Validation √©chou√©e

**Exemples** :

```json
// JSON invalide
{
  "error": "Invalid JSON format",
  "error_code": "INVALID_JSON"
}

// Champ manquant
{
  "error": "Validation failed",
  "details": {
    "title": ["This field is required"]
  },
  "error_code": "VALIDATION_ERROR"
}

// Format incorrect
{
  "error": "Invalid date format",
  "details": {
    "exam_date": ["Expected format: YYYY-MM-DD"]
  },
  "error_code": "INVALID_FORMAT"
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 400) {
  const { error: message, details } = error.response.data

  // Afficher erreurs par champ
  if (details) {
    Object.entries(details).forEach(([field, messages]) => {
      showFieldError(field, messages[0])
    })
  } else {
    showGlobalError(message)
  }
}
```

---

#### 401 - Unauthorized

**Description** : Authentification requise ou credentials invalides.

**Causes Courantes** :
- Session expir√©e
- Token invalide
- Credentials incorrects (login)
- Cookie CSRF manquant

**Exemples** :

```json
// Session expir√©e
{
  "error": "Authentication credentials were not provided",
  "error_code": "AUTH_REQUIRED"
}

// Login √©tudiant √©chou√©
{
  "error": "Invalid credentials",
  "error_code": "INVALID_CREDENTIALS"
}

// CSRF token manquant
{
  "error": "CSRF token missing or incorrect",
  "error_code": "CSRF_ERROR"
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 401) {
  // Rediriger vers login
  router.push('/login')

  // Effacer state
  authStore.logout()

  showError('Votre session a expir√©. Veuillez vous reconnecter.')
}
```

---

#### 403 - Forbidden

**Description** : Acc√®s interdit (permissions insuffisantes).

**Causes Courantes** :
- R√¥le insuffisant (√©tudiant acc√®de √† admin)
- Copie verrouill√©e
- Examen publi√© (modification interdite)
- Acc√®s ressource d'un autre utilisateur

**Exemples** :

```json
// Permission insuffisante
{
  "error": "You do not have permission to perform this action",
  "error_code": "PERMISSION_DENIED"
}

// Copie verrouill√©e
{
  "error": "Copy is locked and cannot be modified",
  "error_code": "COPY_LOCKED"
}

// Examen publi√©
{
  "error": "Cannot modify published exam",
  "error_code": "EXAM_PUBLISHED"
}

// Acc√®s ressource autre user
{
  "error": "You can only access your own copies",
  "error_code": "ACCESS_DENIED"
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 403) {
  const { error: message, error_code } = error.response.data

  switch (error_code) {
    case 'COPY_LOCKED':
      showWarning('Cette copie est verrouill√©e. Contactez un administrateur.')
      router.push('/grading')
      break

    case 'EXAM_PUBLISHED':
      showWarning('Cet examen est publi√© et ne peut plus √™tre modifi√©.')
      break

    default:
      showError('Acc√®s refus√© : ' + message)
  }
}
```

---

#### 404 - Not Found

**Description** : Ressource introuvable.

**Causes Courantes** :
- ID inexistant
- Ressource supprim√©e
- Route API invalide

**Exemples** :

```json
// Ressource inexistante
{
  "error": "Not found",
  "error_code": "NOT_FOUND"
}

// Examen introuvable
{
  "error": "Exam with id 999 not found",
  "error_code": "EXAM_NOT_FOUND"
}

// PDF manquant
{
  "error": "PDF file not found for this copy",
  "error_code": "PDF_NOT_FOUND"
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 404) {
  showError('Ressource introuvable')
  router.push('/exams')  // Rediriger vers liste
}
```

---

#### 409 - Conflict

**Description** : Conflit avec l'√©tat actuel de la ressource.

**Causes Courantes** :
- Email d√©j√† utilis√©
- Identifiant anonyme dupliqu√©
- Copie d√©j√† assign√©e √† un √©tudiant
- Examen d√©j√† finalis√©

**Exemples** :

```json
// Email dupliqu√©
{
  "error": "Student with this email already exists",
  "error_code": "DUPLICATE_EMAIL"
}

// Copie d√©j√† assign√©e
{
  "error": "This copy is already assigned to another student",
  "error_code": "COPY_ALREADY_ASSIGNED"
}

// Examen d√©j√† finalis√©
{
  "error": "Exam has already been finalized",
  "error_code": "EXAM_FINALIZED"
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 409) {
  const { error: message, error_code } = error.response.data

  if (error_code === 'DUPLICATE_EMAIL') {
    showFieldError('email', 'Cet email est d√©j√† utilis√©')
  } else {
    showError(message)
  }
}
```

---

#### 413 - Payload Too Large

**Description** : Fichier upload√© trop volumineux.

**Limites** :
- **PDF Examen** : 100 MB
- **CSV √âtudiants** : 10 MB
- **Image Annotation** : 5 MB

**Exemples** :

```json
{
  "error": "File size exceeds maximum allowed (100 MB)",
  "error_code": "FILE_TOO_LARGE",
  "details": {
    "file_size": 150000000,
    "max_size": 100000000
  }
}
```

**Gestion Frontend** :
```typescript
// Validation avant upload
function validateFileSize(file: File, maxSizeMB: number): boolean {
  const maxBytes = maxSizeMB * 1024 * 1024

  if (file.size > maxBytes) {
    showError(`Fichier trop volumineux (max: ${maxSizeMB} MB)`)
    return false
  }

  return true
}

// Upload avec gestion erreur 413
try {
  await uploadPDF(file)
} catch (error) {
  if (error.response?.status === 413) {
    showError('Fichier trop volumineux. Compressez le PDF et r√©essayez.')
  }
}
```

---

#### 422 - Unprocessable Entity

**Description** : Requ√™te syntaxiquement correcte mais s√©mantiquement invalide.

**Causes Courantes** :
- CSV avec colonnes manquantes
- PDF corrompu
- Format de fichier incorrect
- Logique m√©tier invalide

**Exemples** :

```json
// CSV invalide
{
  "error": "CSV validation failed",
  "error_code": "INVALID_CSV",
  "details": {
    "missing_columns": ["nom", "prenom"],
    "line_errors": [
      "Line 3: Invalid email format",
      "Line 7: Duplicate email"
    ]
  }
}

// PDF corrompu
{
  "error": "PDF file is corrupted and cannot be processed",
  "error_code": "CORRUPTED_PDF"
}

// Notes invalides
{
  "error": "Score exceeds maximum allowed",
  "error_code": "INVALID_SCORE",
  "details": {
    "score": 25.0,
    "max_score": 20.0
  }
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 422) {
  const { error: message, details } = error.response.data

  if (details?.line_errors) {
    // Afficher erreurs CSV ligne par ligne
    const errorList = details.line_errors.join('\n')
    showError(`Erreurs dans le CSV :\n${errorList}`)
  } else {
    showError(message)
  }
}
```

---

#### 429 - Too Many Requests

**Description** : Trop de requ√™tes (rate limiting).

**Limites** :
- **Login √©tudiant** : 5 tentatives / minute
- **API g√©n√©rale** : 100 requ√™tes / minute / user
- **Upload** : 10 uploads / heure

**Exemples** :

```json
{
  "error": "Rate limit exceeded",
  "error_code": "RATE_LIMIT_EXCEEDED",
  "details": {
    "retry_after": 45,  // Secondes
    "limit": 5,
    "window": "1 minute"
  }
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 429) {
  const retryAfter = error.response.data.details?.retry_after || 60

  showError(`Trop de requ√™tes. R√©essayez dans ${retryAfter} secondes.`)

  // Retry automatique apr√®s d√©lai
  setTimeout(() => {
    retryRequest()
  }, retryAfter * 1000)
}
```

---

### 5xx - Erreurs Serveur

#### 500 - Internal Server Error

**Description** : Erreur interne du serveur.

**Causes Courantes** :
- Exception Python non catch√©e
- Bug dans le code backend
- Probl√®me base de donn√©es

**Exemples** :

```json
{
  "error": "Internal server error",
  "error_code": "INTERNAL_ERROR",
  "request_id": "req_abc123xyz"  // Pour tra√ßabilit√© logs
}
```

**Gestion Frontend** :
```typescript
if (error.response.status === 500) {
  const requestId = error.response.data.request_id

  showError(
    `Erreur serveur. Contactez le support avec l'ID : ${requestId}`
  )

  // Logger pour monitoring
  logError('Server error', { requestId, endpoint: error.config.url })
}
```

---

#### 502 - Bad Gateway

**Description** : Nginx ne peut pas joindre le backend.

**Causes** :
- Backend Django arr√™t√©
- Timeout backend
- Configuration Nginx incorrecte

**Gestion Frontend** :
```typescript
if (error.response.status === 502) {
  showError('Service temporairement indisponible. R√©essayez dans quelques instants.')

  // Retry avec backoff exponentiel
  retryWithBackoff(request, { maxRetries: 3, initialDelay: 2000 })
}
```

---

#### 503 - Service Unavailable

**Description** : Service temporairement indisponible (maintenance).

**Gestion Frontend** :
```typescript
if (error.response.status === 503) {
  showWarning('Maintenance en cours. Le service sera de retour sous peu.')

  // Rediriger vers page maintenance
  router.push('/maintenance')
}
```

---

#### 504 - Gateway Timeout

**Description** : Requ√™te trop longue (> 60s).

**Causes Courantes** :
- Traitement PDF batch tr√®s volumineux
- OCR long
- Requ√™te base de donn√©es lente

**Gestion Frontend** :
```typescript
if (error.response.status === 504) {
  showWarning(
    'Le traitement prend plus de temps que pr√©vu. ' +
    'V√©rifiez l\'√©tat dans quelques minutes.'
  )

  // Polling pour v√©rifier completion
  startPolling(taskId)
}
```

---

## üîç Codes d'Erreur M√©tier Korrigo

### Codes Examens

| Code | Message | HTTP | Solution |
|------|---------|------|----------|
| `EXAM_NOT_FOUND` | Examen introuvable | 404 | V√©rifier ID |
| `EXAM_PUBLISHED` | Examen d√©j√† publi√© | 403 | Non modifiable |
| `EXAM_FINALIZED` | Examen finalis√© | 409 | Cr√©er nouvelle version |
| `INVALID_EXAM_DATE` | Date examen invalide | 400 | Date future requise |

### Codes Copies

| Code | Message | HTTP | Solution |
|------|---------|------|----------|
| `COPY_NOT_FOUND` | Copie introuvable | 404 | V√©rifier ID |
| `COPY_LOCKED` | Copie verrouill√©e | 403 | Contacter admin |
| `COPY_ALREADY_ASSIGNED` | Copie d√©j√† assign√©e | 409 | Choisir autre copie |
| `COPY_NOT_IDENTIFIED` | Copie non identifi√©e | 422 | Identifier d'abord |
| `INVALID_SCORE` | Note invalide | 422 | Note ‚â§ max |

### Codes Identification

| Code | Message | HTTP | Solution |
|------|---------|------|----------|
| `OCR_FAILED` | OCR √©chou√© | 422 | Identification manuelle |
| `NO_OCR_CANDIDATES` | Aucun candidat OCR | 404 | Recherche manuelle |
| `STUDENT_NOT_IN_WHITELIST` | √âtudiant pas dans CSV | 422 | V√©rifier CSV |
| `AMBIGUOUS_MATCH` | Match ambigu | 422 | S√©lection manuelle |

### Codes √âtudiants

| Code | Message | HTTP | Solution |
|------|---------|------|----------|
| `INVALID_CREDENTIALS` | Credentials invalides | 401 | V√©rifier email/date |
| `STUDENT_NOT_FOUND` | √âtudiant introuvable | 404 | Contacter enseignant |
| `DUPLICATE_EMAIL` | Email d√©j√† utilis√© | 409 | Utiliser autre email |
| `COPY_NOT_PUBLISHED` | Copie non publi√©e | 403 | Attendre publication |

### Codes Fichiers

| Code | Message | HTTP | Solution |
|------|---------|------|----------|
| `FILE_TOO_LARGE` | Fichier trop volumineux | 413 | Compresser fichier |
| `INVALID_FILE_TYPE` | Type fichier invalide | 400 | Utiliser PDF/CSV |
| `CORRUPTED_PDF` | PDF corrompu | 422 | R√©g√©n√©rer PDF |
| `INVALID_CSV` | CSV invalide | 422 | V√©rifier format |
| `PDF_NOT_FOUND` | PDF introuvable | 404 | R√©-uploader |

### Codes Permissions

| Code | Message | HTTP | Solution |
|------|---------|------|----------|
| `AUTH_REQUIRED` | Authentification requise | 401 | Se connecter |
| `PERMISSION_DENIED` | Permission refus√©e | 403 | Contacter admin |
| `CSRF_ERROR` | Token CSRF invalide | 401 | Rafra√Æchir page |
| `SESSION_EXPIRED` | Session expir√©e | 401 | Se reconnecter |

---

## üõ†Ô∏è Gestion Globale des Erreurs

### Interceptor Axios

**Fichier** : `frontend/src/services/api.ts`

```typescript
import axios from 'axios'
import { useRouter } from 'vue-router'
import { showError, showWarning } from '@/utils/notifications'

// Configuration Axios
const api = axios.create({
  baseURL: '/api',
  timeout: 60000,
  withCredentials: true,
  headers: {
    'Content-Type': 'application/json'
  }
})

// Interceptor r√©ponses
api.interceptors.response.use(
  response => response,
  error => {
    const router = useRouter()
    const { response } = error

    if (!response) {
      // Erreur r√©seau
      showError('Erreur r√©seau. V√©rifiez votre connexion.')
      return Promise.reject(error)
    }

    const { status, data } = response
    const errorMessage = data?.error || 'Une erreur est survenue'
    const errorCode = data?.error_code

    // Gestion par code HTTP
    switch (status) {
      case 400:
        // Validation errors
        if (data.details) {
          handleValidationErrors(data.details)
        } else {
          showError(errorMessage)
        }
        break

      case 401:
        // Authentification requise
        if (errorCode === 'SESSION_EXPIRED') {
          showWarning('Votre session a expir√©')
        }
        router.push('/login')
        break

      case 403:
        // Permission denied
        showError(`Acc√®s refus√© : ${errorMessage}`)
        break

      case 404:
        // Not found
        showError('Ressource introuvable')
        break

      case 409:
        // Conflict
        showWarning(errorMessage)
        break

      case 413:
        // File too large
        showError('Fichier trop volumineux')
        break

      case 422:
        // Unprocessable entity
        if (errorCode === 'INVALID_CSV') {
          handleCSVErrors(data.details)
        } else {
          showError(errorMessage)
        }
        break

      case 429:
        // Rate limit
        const retryAfter = data.details?.retry_after || 60
        showWarning(`Trop de requ√™tes. R√©essayez dans ${retryAfter}s`)
        break

      case 500:
      case 502:
      case 503:
      case 504:
        // Server errors
        showError('Erreur serveur. R√©essayez plus tard.')
        logServerError(response)
        break

      default:
        showError(errorMessage)
    }

    return Promise.reject(error)
  }
)

function handleValidationErrors(details: Record<string, string[]>) {
  Object.entries(details).forEach(([field, messages]) => {
    showFieldError(field, messages[0])
  })
}

function handleCSVErrors(details: any) {
  if (details.line_errors) {
    const errorList = details.line_errors.join('\n')
    showError(`Erreurs CSV :\n${errorList}`)
  }
}

function logServerError(response: any) {
  console.error('Server Error:', {
    status: response.status,
    url: response.config.url,
    requestId: response.data?.request_id,
    timestamp: new Date().toISOString()
  })
}

export default api
```

---

## üß™ Tests des Codes d'Erreur

### Test Backend

**Fichier** : `backend/core/tests/test_errors.py`

```python
from django.test import TestCase
from django.urls import reverse
from rest_framework.test import APIClient
from rest_framework import status

class ErrorCodesTestCase(TestCase):
    def setUp(self):
        self.client = APIClient()

    def test_401_auth_required(self):
        """Test 401 sur endpoint prot√©g√©."""
        response = self.client.get(reverse('exam-list'))

        self.assertEqual(response.status_code, status.HTTP_401_UNAUTHORIZED)
        self.assertEqual(response.data['error_code'], 'AUTH_REQUIRED')

    def test_400_validation_error(self):
        """Test 400 validation."""
        self.client.force_authenticate(user=self.teacher)

        response = self.client.post(reverse('exam-list'), {
            'title': '',  # Required field vide
            'subject': 'Maths'
        })

        self.assertEqual(response.status_code, status.HTTP_400_BAD_REQUEST)
        self.assertEqual(response.data['error_code'], 'VALIDATION_ERROR')
        self.assertIn('title', response.data['details'])

    def test_404_not_found(self):
        """Test 404 ressource inexistante."""
        self.client.force_authenticate(user=self.teacher)

        response = self.client.get(reverse('exam-detail', args=[99999]))

        self.assertEqual(response.status_code, status.HTTP_404_NOT_FOUND)
        self.assertEqual(response.data['error_code'], 'NOT_FOUND')

    def test_403_copy_locked(self):
        """Test 403 copie verrouill√©e."""
        self.client.force_authenticate(user=self.teacher)

        # Cr√©er copie verrouill√©e
        copy = Copy.objects.create(exam=self.exam, is_locked=True)

        response = self.client.patch(
            reverse('copy-detail', args=[copy.id]),
            {'total_score': 15.0}
        )

        self.assertEqual(response.status_code, status.HTTP_403_FORBIDDEN)
        self.assertEqual(response.data['error_code'], 'COPY_LOCKED')
```

---

## üìä Monitoring des Erreurs

### Sentry Integration

```python
# settings.py

import sentry_sdk
from sentry_sdk.integrations.django import DjangoIntegration

sentry_sdk.init(
    dsn="https://your-sentry-dsn",
    integrations=[DjangoIntegration()],
    traces_sample_rate=1.0,
    send_default_pii=True,
    environment="production"
)
```

### Custom Exception Handler

```python
# core/exceptions.py

from rest_framework.views import exception_handler
from rest_framework.response import Response
from django.utils import timezone
import logging

logger = logging.getLogger(__name__)

def custom_exception_handler(exc, context):
    """Handler global des exceptions."""
    response = exception_handler(exc, context)

    if response is not None:
        # Ajouter metadata
        response.data['timestamp'] = timezone.now().isoformat()

        # Logger erreur
        logger.error(
            f"API Error: {exc.__class__.__name__}",
            extra={
                'status_code': response.status_code,
                'error': str(exc),
                'view': context['view'].__class__.__name__,
                'request': context['request'].path
            }
        )

    return response

# settings.py
REST_FRAMEWORK = {
    'EXCEPTION_HANDLER': 'core.exceptions.custom_exception_handler'
}
```

---

## üìù Conclusion

La gestion coh√©rente des codes d'erreur facilite le debugging et am√©liore l'exp√©rience utilisateur. Tous les endpoints Korrigo respectent ces conventions pour assurer une API pr√©visible et maintenable.

**Points cl√©s** :
- Format JSON standardis√© pour toutes les erreurs
- Codes m√©tier explicites (`COPY_LOCKED`, `EXAM_PUBLISHED`, etc.)
- Interceptor Axios centralis√©
- Logging et monitoring avec Sentry
- Tests unitaires des cas d'erreur

---

**Document r√©dig√© par :**
**Alaeddine BEN RHOUMA**
*Lead Senior Documentation & Architecture*
Date : 3 F√©vrier 2026
